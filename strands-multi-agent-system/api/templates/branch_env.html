<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Branch & Environment Tracking - Golden Config AI</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <style>
    :root{
      --vz-red:#B91C1C; --med:#D97706; --low:#4B5563; --allowed: #6B7280;
      --ink:#111827; --muted:#6B7280; --bg:#F9FAFB;
      --panel:#FFFFFF; --line:#E5E7EB; --chip:#F3F4F6;
      --shadow:0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.07);
      --success: #10B981; --success-bg: #D1FAE5;
      --green: #16A34A; --green-bg: #DCFCE7;
      --yellow: #CA8A04; --yellow-bg: #FEF3C7;
      --red: #DC2626; --red-bg: #FEE2E2;
    }
    *{box-sizing:border-box}
    html,body,#root{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    .container{max-width:1400px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:24px}
    .btn{border:1px solid #D1D5DB;background:#FFFFFF;color:#374151;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;}
    .btn:hover{background-color:#F9FAFB;}
    .btn.primary{background: #1F2937; color: white; border-color: #1F2937;}
    .btn.success{background: var(--green); color: white; border-color: var(--green);}
    .btn.warning{background: var(--yellow); color: white; border-color: var(--yellow);}
    .btn.danger{background: var(--red); color: white; border-color: var(--red);}
    
    .header{margin-bottom:32px}
    .back-btn{margin-bottom:16px}
    .title{font-size:24px;font-weight:700;margin:0 0 8px 0;display:flex;align-items:center;gap:12px}
    .subtitle{color:var(--muted);margin:0}
    
    .issue-alert{background:var(--red-bg);border:2px solid var(--red);border-radius:12px;padding:16px;margin-bottom:24px}
    .issue-alert h3{color:var(--red);margin:0 0 8px 0;font-size:18px}
    .issue-alert p{margin:0;color:#7F1D1D}
    
    .tabs{display:flex;background:var(--chip);border-radius:12px;padding:4px;margin-bottom:24px}
    .tab{flex:1;padding:12px 24px;border-radius:8px;background:transparent;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
    .tab.active{background:var(--panel);box-shadow:var(--shadow)}
    
    .grid{display:grid;gap:24px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    
    .status-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .status-item:last-child{margin-bottom:0}
    .status-label{color:var(--muted)}
    .status-value{font-weight:600;display:flex;align-items:center;gap:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px}
    
    .badge{display:inline-flex;align-items:center;padding:6px 16px;border-radius:999px;font-size:12px;font-weight:700;gap:6px;cursor:pointer;transition:all 0.2s}
    .badge:hover{transform:scale(1.05)}
    .badge.success{background:var(--success-bg);color:var(--success);border:2px solid var(--success)}
    .badge.warning{background:var(--yellow-bg);color:var(--yellow);border:2px solid var(--yellow)}
    .badge.danger{background:var(--red-bg);color:var(--red);border:2px solid var(--red)}
    .badge.production{background:var(--chip);color:var(--ink);border:2px solid var(--line)}
    
    .commit-item{padding:16px;border:1px solid var(--line);border-radius:12px;margin-bottom:12px}
    .commit-item:last-child{margin-bottom:0}
    .commit-hash{font-family:monospace;background:var(--chip);padding:4px 8px;border-radius:6px;font-size:12px}
    .commit-meta{color:var(--muted);font-size:13px;margin-top:4px}
    
    .env-cert{display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid var(--line)}
    .env-cert:last-child{border-bottom:none}
    .env-name{font-weight:600;font-size:16px}
    .env-details{color:var(--muted);font-size:13px;margin-top:4px}
    
    .deployment-actions{margin-top:12px;display:flex;gap:8px}
    
    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:white;border-radius:16px;padding:24px;max-width:500px;width:90%;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 16px 0;color:var(--ink)}
    .modal p{margin:0 0 16px 0;color:var(--muted)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    (function(){
      const e = React.createElement;
      
      function BranchEnvironmentPage() {
        const [activeTab, setActiveTab] = React.useState('overview');
        const [showStagingModal, setShowStagingModal] = React.useState(false);
        const [serviceConfig, setServiceConfig] = React.useState(null);
        
        // Get URL parameters to identify the specific issue
        const urlParams = new URLSearchParams(window.location.search);
        const issueId = urlParams.get('id') || 'unknown';
        const file = decodeURIComponent(urlParams.get('file') || 'config_files/application-vbg.yml');
        
        // Get service ID from URL
        const serviceId = window.location.pathname.includes('/service/') 
          ? window.location.pathname.split('/service/')[1] 
          : issueId; // fallback to issueId
        
        // Load service configuration
        React.useEffect(() => {
          const loadServiceConfig = async () => {
            try {
              const servicesResponse = await fetch('/api/services');
              const servicesData = await servicesResponse.json();
              const service = servicesData.services.find(s => s.id === serviceId);
              setServiceConfig(service);
            } catch (err) {
              console.error('Failed to load service config:', err);
            }
          };
          loadServiceConfig();
        }, [serviceId]);
        
        // Mock issue data - in real app, this would be fetched from API
        const issueData = {
          id: issueId,
          file: file,
          riskLevel: 'high', // Could be high, medium, low, allowed
          description: `Configuration drift detected in ${file}`,
          affectedEnvironments: ['production', 'staging'],
          currentBranch: 'main',
          deployedBranch: 'main',
          lastCommit: 'a1b2c3d4'
        };
        
        function goBack() {
          window.history.back();
        }
        
        function handleStagingClick() {
          setShowStagingModal(true);
        }
        
        function handlePromoteToStaging() {
          alert('Promoting changes to staging environment...');
          setShowStagingModal(false);
        }
        
        function handleReviewStaging() {
          alert('Opening staging review workflow...');
          setShowStagingModal(false);
        }
        
        return e('div', {className: 'container'}, [
          // Header
          e('div', {className: 'header'}, [
            e('button', {className: 'btn back-btn', onClick: goBack}, [
              e('span', null, 'â†'),
              'Back to Issues'
            ]),
            e('h1', {className: 'title'}, [
              e('span', null, 'ðŸŒ¿'),
              `Branch & Environment - ${serviceConfig?.name || 'Service'}`
            ]),
            e('p', {className: 'subtitle'}, `Track git branches, deployments, and environment-specific certifications`)
          ]),
          
          // Risk banner removed from Overview tab as requested
          
          // Tabs
          e('div', {className: 'tabs'}, [
            e('button', {
              className: `tab ${activeTab === 'overview' ? 'active' : ''}`,
              onClick: () => setActiveTab('overview')
            }, 'Overview'),
            e('button', {
              className: `tab ${activeTab === 'deployment' ? 'active' : ''}`,
              onClick: () => setActiveTab('deployment')
            }, 'Deployment Pipeline'),
            e('button', {
              className: `tab ${activeTab === 'certifications' ? 'active' : ''}`,
              onClick: () => setActiveTab('certifications')
            }, 'Certifications'),
            e('button', {
              className: `tab ${activeTab === 'history' ? 'active' : ''}`,
              onClick: () => setActiveTab('history')
            }, 'Change History')
          ]),
          
          // Tab Content
          activeTab === 'overview' && e(OverviewTab, {issueData, onStagingClick: handleStagingClick, serviceConfig, serviceId}),
          activeTab === 'deployment' && e(DeploymentTab, {issueData, onStagingClick: handleStagingClick}),
          activeTab === 'certifications' && e(CertificationsTab, {issueData, onStagingClick: handleStagingClick, serviceConfig, serviceId}),
          activeTab === 'history' && e(HistoryTab, {issueData}),
          
          // Staging Modal
          showStagingModal && e(StagingModal, {
            onClose: () => setShowStagingModal(false),
            onPromote: handlePromoteToStaging,
            onReview: handleReviewStaging,
            issueData
          })
        ]);
      }
      
      function OverviewTab({issueData, onStagingClick, serviceConfig, serviceId}) {
        const [branchStatus, setBranchStatus] = React.useState({});
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [selectedEnv, setSelectedEnv] = React.useState(null);
        const [showBranchDetails, setShowBranchDetails] = React.useState(false);
        
        // Load branch status for all environments
        React.useEffect(() => {
          const loadBranchData = async () => {
            if (!serviceConfig) return;
            
            try {
              // Get environments from service configuration (no hardcoded values)
              const environments = serviceConfig?.environments || ['prod', 'dev', 'qa', 'staging'];
              
              // Load branch status for all environments
              const statusData = {};
              for (const env of environments) {
                try {
                  const response = await fetch(`/api/services/${serviceId}/branches/${env}`);
                  const data = await response.json();
                  statusData[env] = data;
                } catch (err) {
                  statusData[env] = { error: err.message };
                }
              }
              setBranchStatus(statusData);
              
            } catch (err) {
              setError(`Failed to load data: ${err.message}`);
            } finally {
              setLoading(false);
            }
          };
          loadBranchData();
        }, [serviceConfig, serviceId]);
        
        const handleEnvClick = (env) => {
          const status = branchStatus[env];
          if (status && status.active_golden_branch) {
            setSelectedEnv(env);
            setShowBranchDetails(true);
          }
        };
        
        const closeBranchDetails = () => {
          setShowBranchDetails(false);
          setSelectedEnv(null);
        };
        
        const getEnvironmentDisplayName = (env) => {
          const names = {
            'prod': 'Production',
            'dev': 'Development', 
            'qa': 'QA',
            'staging': 'Staging'
          };
          return names[env] || env;
        };
        
        const getEnvironmentColor = (env) => {
          const colors = {
            'prod': 'var(--red)',
            'dev': 'var(--green)',
            'qa': 'var(--yellow)', 
            'staging': 'var(--med)'
          };
          return colors[env] || 'var(--muted)';
        };
        
        return e('div', {className: 'grid grid-2'}, [
          // Environment Status Overview (moved to left)
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0', fontSize: '18px'}}, 'Environment Certification Status'),
            
            error ? e('div', {style: {color: 'var(--red)', padding: '12px', background: 'var(--red-bg)', borderRadius: '8px', marginBottom: '16px'}}, 
              `âŒ ${error}`
            ) : null,
            
            loading ? e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Loading environment data...') :
            (() => {
              // Get environments from service config (dynamic, no hardcoded values)
              const environments = serviceConfig?.environments || [];
              
              if (environments.length === 0) {
                return e('div', {style: {textAlign: 'center', padding: '40px 20px', color: 'var(--muted)'}}, [
                  e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, 'ðŸŒ¿'),
                  e('div', {style: {fontSize: '16px', fontWeight: '600', marginBottom: '8px'}}, 'No Environments Configured'),
                  e('div', {style: {fontSize: '14px'}}, 'Check service configuration')
                ]);
              }
              
              return environments.map(env => {
                const status = branchStatus[env] || {};
                const hasGolden = status.active_golden_branch;
                const goldenCount = status.total_golden || 0;
                const driftCount = status.total_drift || 0;
                const isCertified = hasGolden;
                
                return e('div', {
                  key: env, 
                  className: 'env-cert',
                  style: {cursor: isCertified ? 'pointer' : 'default', transition: 'all 0.2s'},
                  onClick: () => isCertified && handleEnvClick(env)
                }, [
                  e('div', null, [
                    e('div', {className: 'env-name', style: {color: getEnvironmentColor(env)}}, 
                      getEnvironmentDisplayName(env)
                    ),
                    e('div', {className: 'env-details'}, 
                      `Golden: ${hasGolden || 'None'}`
                    ),
                    e('div', {className: 'env-details'}, 
                      `${goldenCount} golden, ${driftCount} drift branches`
                    ),
                    isCertified && e('div', {className: 'env-details', style: {color: 'var(--muted)', fontSize: '12px', marginTop: '4px'}}, 
                      'Click to view details â†’'
                    )
                  ]),
                  e('div', {style: {display: 'flex', alignItems: 'center', gap: '8px'}}, [
                    isCertified ? 
                      e('span', {className: 'badge success'}, [
                        e('span', null, 'ðŸ†'),
                        'Certified'
                      ]) :
                      e('span', {className: 'badge warning'}, [
                        e('span', null, 'â³'),
                        'Not Certified'
                      ])
                  ])
                ]);
              });
            })()
          ]),
          
          // Service Overview Card (moved to right)
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0', fontSize: '18px'}}, 'Service Overview'),
            
            error ? e('div', {style: {color: 'var(--red)', padding: '12px', background: 'var(--red-bg)', borderRadius: '8px', marginBottom: '16px'}}, 
              `âŒ ${error}`
            ) : null,
            
            loading ? e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Loading service data...') :
            serviceConfig ? [
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Service:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ðŸ¢'),
                  e('span', {className: 'mono'}, serviceConfig.name || serviceId)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Service ID:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ðŸ†”'),
                  e('span', {className: 'mono'}, serviceId)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Main Branch:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ðŸŒ¿'),
                  e('span', {className: 'mono'}, serviceConfig.main_branch || 'main')
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Environments:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ðŸŒ'),
                  e('span', null, `${serviceConfig.environments ? serviceConfig.environments.length : 0} configured`)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Repository:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ðŸ“¦'),
                  e('span', {style: {fontSize: '12px', wordBreak: 'break-all'}}, serviceConfig.repo_url || 'Unknown')
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Status:'),
                e('span', {className: serviceConfig.status === 'warning' ? 'badge warning' : 'badge success'}, 
                  serviceConfig.status === 'warning' ? 'âš ï¸ Warning' : 'âœ… Active'
                )
              ])
            ] : e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Service not found')
          ]),
          
          // Branch Details Popup
          showBranchDetails && selectedEnv && e('div', {className: 'modal-overlay', onClick: closeBranchDetails}, [
            e('div', {className: 'modal', onClick: (e) => e.stopPropagation()}, [
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}, [
                e('h3', {style: {margin: 0, fontSize: '20px'}}, [
                  e('span', {style: {marginRight: '8px'}}, 'ðŸŒ¿'),
                  `${getEnvironmentDisplayName(selectedEnv)} - Branch Details`
                ]),
                e('button', {
                  onClick: closeBranchDetails,
                  style: {background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: 'var(--muted)'}
                }, 'Ã—')
              ]),
              
              (() => {
                const status = branchStatus[selectedEnv] || {};
                const goldenBranch = status.active_golden_branch;
                const goldenBranches = status.golden_branches || [];
                const driftBranches = status.drift_branches || [];
                const service = serviceConfig;
                
                if (!service) {
                  return e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Service data not available');
                }
                
                return [
                  // Current Golden Branch
                  e('div', {style: {marginBottom: '24px'}}, [
                    e('h4', {style: {margin: '0 0 12px 0', color: 'var(--green)'}}, 'Active Golden Branch'),
                    e('div', {style: {background: 'var(--green-bg)', padding: '16px', borderRadius: '8px', border: '1px solid var(--green)'}}, [
                      e('div', {style: {fontFamily: 'monospace', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}, goldenBranch),
                      e('div', {style: {display: 'flex', gap: '12px', alignItems: 'center'}}, [
                        e('a', {
                          href: `${service.repo_url}/-/tree/${goldenBranch}`,
                          target: '_blank',
                          style: {color: 'var(--green)', textDecoration: 'none', fontWeight: '600'},
                          onMouseOver: (e) => e.target.style.textDecoration = 'underline',
                          onMouseOut: (e) => e.target.style.textDecoration = 'none'
                        }, 'ðŸ”— View in GitLab'),
                        e('span', {style: {color: 'var(--muted)', fontSize: '12px'}}, 'Opens in new tab')
                      ])
                    ])
                  ]),
                  
                  // Branch Statistics
                  e('div', {style: {display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px'}}, [
                    e('div', {style: {background: 'var(--chip)', padding: '16px', borderRadius: '8px'}}, [
                      e('div', {style: {fontSize: '24px', fontWeight: '700', color: 'var(--green)', marginBottom: '4px'}}, goldenBranches.length),
                      e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 'Golden Branches')
                    ]),
                    e('div', {style: {background: 'var(--chip)', padding: '16px', borderRadius: '8px'}}, [
                      e('div', {style: {fontSize: '24px', fontWeight: '700', color: 'var(--med)', marginBottom: '4px'}}, driftBranches.length),
                      e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 'Drift Branches')
                    ])
                  ]),
                  
                  // Recent Branches
                  e('div', {style: {marginBottom: '16px'}}, [
                    e('h4', {style: {margin: '0 0 12px 0'}}, 'Recent Drift Branches'),
                    driftBranches.length > 0 ? 
                      e('div', {style: {maxHeight: '200px', overflowY: 'auto'}}, 
                        driftBranches.slice(0, 5).map(branch => 
                          e('div', {key: branch, style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--line)'}}, [
                            e('span', {style: {fontFamily: 'monospace', fontSize: '12px'}}, branch),
                            e('a', {
                              href: `${service.repo_url}/-/tree/${branch}`,
                              target: '_blank',
                              style: {color: 'var(--med)', textDecoration: 'none', fontSize: '12px'},
                              onMouseOver: (e) => e.target.style.textDecoration = 'underline',
                              onMouseOut: (e) => e.target.style.textDecoration = 'none'
                            }, 'View')
                          ])
                        )
                      ) :
                      e('div', {style: {color: 'var(--muted)', fontStyle: 'italic'}}, 'No drift branches yet')
                  ])
                ];
              })()
            ])
          ])
        ]);
      }
      
      function DeploymentTab({issueData, onStagingClick}) {
        return e('div', {className: 'grid'}, [
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0'}}, 'Deployment Pipeline Status'),
            
            // Production Deployment
            e('div', {className: 'commit-item', style: {borderColor: 'var(--green)'}}, [
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}, [
                e('div', null, [
                  e('h4', {style: {margin: '0', color: 'var(--green)'}}, 'Production'),
                  e('div', {className: 'commit-meta'}, 'Branch: main â€¢ Last deployed: 2 hours ago')
                ]),
                e('span', {className: 'badge success'}, 'Active')
              ]),
              e('div', {className: 'deployment-actions'}, [
                e('button', {className: 'btn success'}, 'View Logs'),
                e('button', {className: 'btn'}, 'Rollback')
              ])
            ]),
            
            // Staging Deployment - Clickable
            e('div', {className: 'commit-item', style: {borderColor: 'var(--yellow)', cursor: 'pointer'}, onClick: onStagingClick}, [
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}, [
                e('div', null, [
                  e('h4', {style: {margin: '0', color: 'var(--yellow)'}}, 'Staging'),
                  e('div', {className: 'commit-meta'}, 'Branch: staging â€¢ Pending deployment â€¢ Click to manage')
                ]),
                e('div', {style: {display: 'flex', gap: '8px'}}, [
                  e('span', {className: 'badge warning'}, 'Pending'),
                  e('span', {style: {color: 'var(--muted)'}}, 'â†’')
                ])
              ]),
              e('div', {className: 'deployment-actions'}, [
                e('button', {className: 'btn warning', onClick: (e) => {e.stopPropagation(); onStagingClick()}}, 'Deploy to Staging'),
                e('button', {className: 'btn'}, 'Review Changes')
              ])
            ])
          ])
        ]);
      }
      
      function CertificationsTab({issueData, onStagingClick, serviceConfig, serviceId}) {
        const [certifications, setCertifications] = React.useState({});
        const [loading, setLoading] = React.useState({});
        const [error, setError] = React.useState(null);
        
        // Load certification status for all environments
        React.useEffect(() => {
          const loadCertifications = async () => {
            if (!serviceConfig) return;
            
            // Get environments from service configuration (no hardcoded values)
            const environments = serviceConfig?.environments || ['prod', 'dev', 'qa', 'staging'];
            
            const certData = {};
            for (const env of environments) {
              try {
                const response = await fetch(`/api/services/${serviceId}/validate-golden/${env}`);
                const data = await response.json();
                certData[env] = data;
              } catch (err) {
                certData[env] = { golden_exists: false, error: err.message };
              }
            }
            setCertifications(certData);
          };
          loadCertifications();
        }, [serviceConfig, serviceId]);
        
        const handleCertify = async (environment) => {
          setLoading(prev => ({ ...prev, [environment]: true }));
          setError(null);
          
          try {
            const response = await fetch(`/api/services/${serviceId}/set-golden/${environment}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to certify ${environment}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Update certifications state
            setCertifications(prev => ({
              ...prev,
              [environment]: {
                golden_exists: true,
                active_golden_branch: result.branch_name,
                service_id: serviceId,
                environment: environment
              }
            }));
            
          } catch (err) {
            setError(`Failed to certify ${environment}: ${err.message}`);
          } finally {
            setLoading(prev => ({ ...prev, [environment]: false }));
          }
        };
        
        const getEnvironmentDisplayName = (env) => {
          const names = {
            'prod': 'Production',
            'dev': 'Development', 
            'qa': 'QA',
            'staging': 'Staging'
          };
          return names[env] || env;
        };
        
        const getEnvironmentColor = (env) => {
          const colors = {
            'prod': 'var(--red)',
            'dev': 'var(--green)',
            'qa': 'var(--yellow)', 
            'staging': 'var(--med)'
          };
          return colors[env] || 'var(--muted)';
        };
        
        return e('div', {className: 'card'}, [
          e('h3', {style: {margin: '0 0 20px 0'}}, 'Environment Certification & Golden Branches'),
          e('p', {style: {color: 'var(--muted)', margin: '0 0 24px 0'}}, 
            'Certify environments to create golden branches for drift analysis baseline'),
          
          // Error message
          error && e('div', {style: {background: 'var(--red-bg)', border: '1px solid var(--red)', borderRadius: '8px', padding: '12px', marginBottom: '16px', color: 'var(--red)'}}, 
            `âŒ ${error}`
          ),
          
          // Environment certifications
          ...(() => {
            // Get environments from service config (dynamic, no hardcoded values)
            const environments = serviceConfig?.environments || [];
            return environments.map(env => {
            const cert = certifications[env] || {};
            const isCertified = cert.golden_exists;
            const isLoading = loading[env];
            
            return e('div', {key: env, className: 'env-cert'}, [
              e('div', null, [
                e('div', {className: 'env-name', style: {color: getEnvironmentColor(env)}}, 
                  getEnvironmentDisplayName(env)
                ),
                isCertified ? [
                  e('div', {className: 'env-details'}, 
                    `Golden Branch: ${cert.active_golden_branch || 'Unknown'}`
                  ),
                  e('div', {className: 'env-details'}, 
                    `Certified and ready for drift analysis`
                  )
                ] : [
                  e('div', {className: 'env-details'}, 
                    'No golden branch found - certification required'
                  ),
                  e('div', {className: 'env-details'}, 
                    'Click "Certify" to create golden baseline'
                  )
                ]
              ]),
              e('div', {style: {display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '8px'}}, [
                isCertified ? [
                  e('span', {className: 'badge success'}, [
                    e('span', null, 'ðŸ†'),
                    'Certified'
                  ]),
                  e('button', {
                    className: 'btn',
                    onClick: () => window.open(`/api/services/${serviceId}/branches/${env}`, '_blank')
                  }, 'View Branches')
                ] : [
                  e('span', {className: 'badge warning'}, [
                    e('span', null, 'â³'),
                    'Not Certified'
                  ]),
                  e('button', {
                    className: 'btn success',
                    disabled: isLoading,
                    onClick: () => handleCertify(env)
                  }, isLoading ? 'Certifying...' : 'Certify')
                ]
              ])
            ]);
          });
          })()
        ]);
      }
      
      function HistoryTab({issueData}) {
        return e('div', {className: 'card'}, [
          e('h3', {style: {margin: '0 0 20px 0'}}, 'Change History'),
          
          e('div', {className: 'commit-item'}, [
            e('div', {style: {display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}, [
              e('span', {className: 'commit-hash'}, 'a1b2c3d4'),
              e('span', {className: 'badge success'}, 'Deployed')
            ]),
            e('div', {className: 'commit-meta'}, 'production â€¢ 2 hours ago â€¢ Sarah Chen'),
            e('div', {style: {marginTop: '4px'}}, 'feat: update session timeout configuration')
          ]),
          
          e('div', {className: 'commit-item'}, [
            e('div', {style: {display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}, [
              e('span', {className: 'commit-hash'}, 'x9y8z7w6'),
              e('span', {className: 'badge warning'}, 'Testing')
            ]),
            e('div', {className: 'commit-meta'}, 'staging â€¢ 1 day ago â€¢ Mike Johnson'),
            e('div', {style: {marginTop: '4px'}}, 'fix: resolve database connection timeout')
          ]),
          
          e('div', {className: 'commit-item'}, [
            e('div', {style: {display: 'flex', justifyContent: 'space-between', marginBottom: '8px'}}, [
              e('span', {className: 'commit-hash'}, 'p7q6r5s4'),
              e('span', {className: 'badge danger'}, 'Failed')
            ]),
            e('div', {className: 'commit-meta'}, 'staging â€¢ 2 days ago â€¢ Alex Wong'),
            e('div', {style: {marginTop: '4px'}}, 'config: attempt to update authentication settings')
          ])
        ]);
      }
      
      function StagingModal({onClose, onPromote, onReview, issueData}) {
        return e('div', {className: 'modal-overlay', onClick: onClose}, [
          e('div', {className: 'modal', onClick: (e) => e.stopPropagation()}, [
            e('h3', null, 'ðŸ”„ Staging Environment Actions'),
            e('p', null, `Manage staging deployment for ${issueData.file}`),
            e('p', {style: {color: 'var(--yellow)'}}, 'Current Status: Pending Certification Review'),
            
            e('div', {style: {background: '#fff8dc', padding: '12px', borderRadius: '8px', margin: '16px 0'}}, [
              e('strong', null, 'Available Actions:'),
              e('ul', {style: {margin: '8px 0 0 0'}}, [
                e('li', null, 'Promote changes to staging for testing'),
                e('li', null, 'Request security team review'),
                e('li', null, 'Schedule certification review meeting')
              ])
            ]),
            
            e('div', {className: 'modal-actions'}, [
              e('button', {className: 'btn', onClick: onClose}, 'Cancel'),
              e('button', {className: 'btn warning', onClick: onReview}, 'Request Review'),
              e('button', {className: 'btn success', onClick: onPromote}, 'Promote to Staging')
            ])
          ])
        ]);
      }
      
      ReactDOM.createRoot(document.getElementById('root')).render(e(BranchEnvironmentPage));
    })();
  </script>
</body>
</html>