<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Branch & Environment Tracking - Golden Config AI</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <style>
    :root{
      --vz-red:#B91C1C; --med:#D97706; --low:#4B5563; --allowed: #6B7280;
      --ink:#111827; --muted:#6B7280; --bg:#F9FAFB;
      --panel:#FFFFFF; --line:#E5E7EB; --chip:#F3F4F6;
      --shadow:0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.07);
      --success: #059669; --success-bg: #ECFDF5;
      --green: #059669; --green-bg: #ECFDF5;
      --yellow: #6B7280; --yellow-bg: #F3F4F6;
      --red: #6B7280; --red-bg: #F3F4F6;
    }
    *{box-sizing:border-box}
    html,body,#root{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    .container{max-width:1400px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:24px}
    .btn{border:1px solid #D1D5DB;background:#FFFFFF;color:#374151;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;}
    .btn:hover{background-color:#F9FAFB;}
    .btn.primary{background: #4B5563; color: white; border-color: #4B5563;}
    .btn.success{background: #4B5563; color: white; border-color: #4B5563;}
    .btn.warning{background: #6B7280; color: white; border-color: #6B7280;}
    .btn.danger{background: #6B7280; color: white; border-color: #6B7280;}
    
    .header{margin-bottom:32px}
    .back-btn{margin-bottom:16px}
    .title{font-size:24px;font-weight:700;margin:0 0 8px 0;display:flex;align-items:center;gap:12px}
    .subtitle{color:var(--muted);margin:0}
    
    .issue-alert{background:var(--red-bg);border:2px solid var(--red);border-radius:12px;padding:16px;margin-bottom:24px}
    .issue-alert h3{color:var(--red);margin:0 0 8px 0;font-size:18px}
    .issue-alert p{margin:0;color:#7F1D1D}
    
    .tabs{display:flex;background:var(--chip);border-radius:12px;padding:4px;margin-bottom:24px}
    .tab{flex:1;padding:12px 24px;border-radius:8px;background:transparent;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
    .tab.active{background:var(--panel);box-shadow:var(--shadow)}
    
    .grid{display:grid;gap:24px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    
    .status-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .status-item:last-child{margin-bottom:0}
    .status-label{color:var(--muted)}
    .status-value{font-weight:600;display:flex;align-items:center;gap:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px}
    
    .badge{display:inline-flex;align-items:center;padding:6px 16px;border-radius:999px;font-size:12px;font-weight:700;gap:6px;cursor:pointer;transition:all 0.2s}
    .badge:hover{transform:scale(1.05)}
    .badge.success{background:var(--success-bg);color:var(--success);border:1px solid var(--success)}
    .badge.warning{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow)}
    .badge.danger{background:var(--red-bg);color:var(--red);border:1px solid var(--red)}
    .badge.production{background:var(--chip);color:var(--ink);border:1px solid var(--line)}
    
    .commit-item{padding:16px;border:1px solid var(--line);border-radius:12px;margin-bottom:12px}
    .commit-item:last-child{margin-bottom:0}
    .commit-hash{font-family:monospace;background:var(--chip);padding:4px 8px;border-radius:6px;font-size:12px}
    .commit-meta{color:var(--muted);font-size:13px;margin-top:4px}
    
    .env-cert{display:block;padding:16px 0;border-bottom:1px solid var(--line)}
    .env-cert:last-child{border-bottom:none}
    .env-name{font-weight:600;font-size:16px}
    .env-details{color:var(--muted);font-size:13px;margin-top:4px}
    
    .deployment-actions{margin-top:12px;display:flex;gap:8px}
    
    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:white;border-radius:16px;padding:24px;max-width:500px;width:90%;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 16px 0;color:var(--ink)}
    .modal p{margin:0 0 16px 0;color:var(--muted)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    (function(){
      const e = React.createElement;
      
      function BranchEnvironmentPage() {
        const [activeTab, setActiveTab] = React.useState('overview');
        const [showStagingModal, setShowStagingModal] = React.useState(false);
        const [serviceConfig, setServiceConfig] = React.useState(null);
        const [certificationUpdateTrigger, setCertificationUpdateTrigger] = React.useState(0);
        
        // Get URL parameters to identify the service
        const urlParams = new URLSearchParams(window.location.search);
        const serviceId = urlParams.get('id') || 'unknown';
        
        // Note: Removed 'file' parameter as it was unused placeholder code
        
        // Load service configuration
        React.useEffect(() => {
          const loadServiceConfig = async () => {
            try {
              const servicesResponse = await fetch('/api/services');
              const servicesData = await servicesResponse.json();
              const service = servicesData.services.find(s => s.id === serviceId);
              setServiceConfig(service);
            } catch (err) {
              console.error('Failed to load service config:', err);
            }
          };
          loadServiceConfig();
        }, [serviceId]);
        
        // Mock issue data - in real app, this would be fetched from API
        const issueData = {
          id: serviceId,
          riskLevel: 'high', // Could be high, medium, low, allowed
          description: `Configuration drift detected for ${serviceConfig?.name || serviceId}`,
          affectedEnvironments: ['production', 'staging'],
          currentBranch: 'main',
          deployedBranch: 'main',
          lastCommit: 'a1b2c3d4'
        };
        
        function goBack() {
          window.history.back();
        }
        
        function handleStagingClick() {
          setShowStagingModal(true);
        }
        
        function handlePromoteToStaging() {
          alert('Promoting changes to staging environment...');
          setShowStagingModal(false);
        }
        
        function handleReviewStaging() {
          alert('Opening staging review workflow...');
          setShowStagingModal(false);
        }
        
        function triggerCertificationUpdate() {
          setCertificationUpdateTrigger(prev => prev + 1);
        }
        
        return e('div', {className: 'container'}, [
          // Header
          e('div', {className: 'header'}, [
            e('div', {style: {marginBottom: '16px'}}, [
            e('button', {className: 'btn back-btn', onClick: goBack}, [
              e('span', null, '←'),
              'Back to Issues'
              ])
            ]),
            e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px'}}, [
              e('div', null, [
                e('h1', {className: 'title', style: {marginBottom: '8px'}}, [
                  e('span', null, '⚙'),
                  `Branch & Environment - ${serviceConfig?.name || 'Service'}`
                ]),
                e('p', {className: 'subtitle'}, `Track git branches, deployments, and environment-specific certifications`)
              ]),
              e('button', {
                className: 'btn',
                onClick: () => {
                  // Trigger analysis - you can customize this
                  window.location.href = `/service/${serviceId}`;
                },
                style: {marginLeft: '16px', backgroundColor: '#4B5563', color: 'white', border: '1px solid #4B5563'}
              }, '▶️ Analyze')
            ])
          ]),
          
          // Risk banner removed from Overview tab as requested
          
          // Tabs
          e('div', {className: 'tabs'}, [
            e('button', {
              className: `tab ${activeTab === 'overview' ? 'active' : ''}`,
              onClick: () => setActiveTab('overview')
            }, 'Overview'),
            e('button', {
              className: `tab ${activeTab === 'certifications' ? 'active' : ''}`,
              onClick: () => setActiveTab('certifications')
            }, 'Certifications'),
            e('button', {
              className: `tab ${activeTab === 'deployment' ? 'active' : ''}`,
              onClick: () => setActiveTab('deployment')
            }, 'Drift Analysis'),
            e('button', {
              className: `tab ${activeTab === 'history' ? 'active' : ''}`,
              onClick: () => setActiveTab('history')
            }, 'Analysis History')
          ]),
          
          // Tab Content (reordered to match tab order)
          activeTab === 'overview' && e(OverviewTab, {issueData, onStagingClick: handleStagingClick, serviceConfig, serviceId, certificationUpdateTrigger}),
          activeTab === 'certifications' && e(CertificationsTab, {issueData, onStagingClick: handleStagingClick, serviceConfig, serviceId, onCertificationUpdate: triggerCertificationUpdate}),
          activeTab === 'deployment' && e(DeploymentTab, {serviceId, currentEnvironment: 'prod'}),
          activeTab === 'history' && e(HistoryTab, {serviceId, currentEnvironment: 'prod'}),
          
          // Staging Modal
          showStagingModal && e(StagingModal, {
            onClose: () => setShowStagingModal(false),
            onPromote: handlePromoteToStaging,
            onReview: handleReviewStaging,
            issueData
          })
        ]);
      }
      
      function OverviewTab({issueData, onStagingClick, serviceConfig, serviceId, certificationUpdateTrigger}) {
        const [branchStatus, setBranchStatus] = React.useState({});
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [selectedEnv, setSelectedEnv] = React.useState(null);
        const [showBranchDetails, setShowBranchDetails] = React.useState(false);
        
        // Load branch status for all environments
        React.useEffect(() => {
          const loadBranchData = async () => {
            if (!serviceConfig) return;
            
            try {
              // Get environments from service configuration (no hardcoded values)
              const environments = serviceConfig?.environments || ['prod', 'dev', 'qa', 'staging'];
              
              // Load branch status for all environments
              const statusData = {};
              for (const env of environments) {
                try {
                  const response = await fetch(`/api/services/${serviceId}/branches/${env}`);
                  const data = await response.json();
                  statusData[env] = data;
                } catch (err) {
                  statusData[env] = { error: err.message };
                }
              }
              setBranchStatus(statusData);
              
            } catch (err) {
              setError(`Failed to load data: ${err.message}`);
            } finally {
              setLoading(false);
            }
          };
          loadBranchData();
        }, [serviceConfig, serviceId, certificationUpdateTrigger]);
        
        const handleEnvClick = (env) => {
          const status = branchStatus[env];
          if (status && status.active_golden_branch) {
            setSelectedEnv(env);
            setShowBranchDetails(true);
          }
        };
        
        const closeBranchDetails = () => {
          setShowBranchDetails(false);
          setSelectedEnv(null);
        };
        
        const getEnvironmentDisplayName = (env) => {
          const names = {
            'prod': 'Production',
            'dev': 'Development', 
            'qa': 'QA',
            'staging': 'Staging'
          };
          return names[env] || env;
        };
        
        const getEnvironmentColor = (env) => {
          const colors = {
            'prod': 'var(--ink)',
            'dev': 'var(--ink)',
            'qa': 'var(--ink)', 
            'staging': 'var(--ink)'
          };
          return colors[env] || 'var(--muted)';
        };
        
        return e('div', {className: 'grid grid-2'}, [
          // Environment Status Overview (moved to left)
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0', fontSize: '18px'}}, 'Environment Certification Status'),
            
            error ? e('div', {style: {color: 'var(--red)', padding: '12px', background: 'var(--red-bg)', borderRadius: '8px', marginBottom: '16px'}}, 
              `❌ ${error}`
            ) : null,
            
            loading ? e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Loading environment data...') :
            (() => {
              // Get environments from service config (dynamic, no hardcoded values)
              const environments = serviceConfig?.environments || [];
              
              if (environments.length === 0) {
                return e('div', {style: {textAlign: 'center', padding: '40px 20px', color: 'var(--muted)'}}, [
                  e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, '⚙'),
                  e('div', {style: {fontSize: '16px', fontWeight: '600', marginBottom: '8px'}}, 'No Environments Configured'),
                  e('div', {style: {fontSize: '14px'}}, 'Check service configuration')
                ]);
              }
              
              return environments.map(env => {
                const status = branchStatus[env] || {};
                const hasGolden = status.active_golden_branch;
                const goldenCount = status.total_golden || 0;
                const driftCount = status.total_drift || 0;
                const isCertified = hasGolden;
                
                return e('div', {
                  key: env, 
                  className: 'env-cert',
                  style: {cursor: isCertified ? 'pointer' : 'default', transition: 'all 0.2s'},
                  onClick: () => isCertified && handleEnvClick(env)
                }, [
                  e('div', null, [
                    e('div', {className: 'env-name', style: {color: getEnvironmentColor(env)}}, 
                      getEnvironmentDisplayName(env)
                    ),
                    e('div', {className: 'env-details'}, 
                      `Golden: ${hasGolden || 'None'}`
                    ),
                    e('div', {className: 'env-details'}, 
                      `${goldenCount} golden, ${driftCount} drift branches`
                    ),
                    isCertified && e('div', {className: 'env-details', style: {color: 'var(--muted)', fontSize: '12px', marginTop: '4px'}}, 
                      'Click to view details →'
                    )
                  ]),
                  e('div', {style: {display: 'flex', alignItems: 'center', gap: '8px'}}, [
                    isCertified && e('span', {className: 'badge success'}, [
                      e('span', null, '✓'),
                      'Certified'
                    ])
                  ])
                ]);
              });
            })()
          ]),
          
          // Service Overview Card (moved to right)
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0', fontSize: '18px'}}, 'Service Overview'),
            
            error ? e('div', {style: {color: 'var(--red)', padding: '12px', background: 'var(--red-bg)', borderRadius: '8px', marginBottom: '16px'}}, 
              `❌ ${error}`
            ) : null,
            
            loading ? e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Loading service data...') :
            serviceConfig ? [
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Service:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, '⚙'),
                  e('span', {className: 'mono'}, serviceConfig.name || serviceId)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Service ID:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ID'),
                  e('span', {className: 'mono'}, serviceId)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Main Branch:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'BR'),
                  e('span', {className: 'mono'}, serviceConfig.main_branch || 'main')
              ])
            ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Environments:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ENV'),
                  e('span', null, `${serviceConfig.environments ? serviceConfig.environments.length : 0} configured`)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Repository:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'REPO'),
                  e('span', {style: {fontSize: '12px', wordBreak: 'break-all'}}, serviceConfig.repo_url || 'Unknown')
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Status:'),
                e('span', {className: serviceConfig.status === 'warning' ? 'badge warning' : 'badge success'}, 
                  serviceConfig.status === 'warning' ? '⚠ Warning' : '✓ Active'
                )
              ])
            ] : e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Service not found')
          ]),
          
          // Branch Details Popup
          showBranchDetails && selectedEnv && e('div', {className: 'modal-overlay', onClick: closeBranchDetails}, [
            e('div', {className: 'modal', onClick: (e) => e.stopPropagation()}, [
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}, [
                e('h3', {style: {margin: 0, fontSize: '20px'}}, [
                  e('span', {style: {marginRight: '8px'}}, '⚙'),
                  `${getEnvironmentDisplayName(selectedEnv)} - Branch Details`
                ]),
                e('button', {
                  onClick: closeBranchDetails,
                  style: {background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: 'var(--muted)'}
                }, '×')
              ]),
              
              (() => {
                const status = branchStatus[selectedEnv] || {};
                const goldenBranch = status.active_golden_branch;
                const goldenBranches = status.golden_branches || [];
                const driftBranches = status.drift_branches || [];
                const service = serviceConfig;
                
                if (!service) {
                  return e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Service data not available');
                }
                
                return [
                  // Current Golden Branch
                  e('div', {style: {marginBottom: '24px'}}, [
                    e('h4', {style: {margin: '0 0 12px 0', color: 'var(--green)'}}, 'Active Golden Branch'),
                    e('div', {style: {background: 'var(--green-bg)', padding: '16px', borderRadius: '8px', border: '1px solid var(--green)'}}, [
                      e('div', {style: {fontFamily: 'monospace', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}, goldenBranch),
                      e('div', {style: {display: 'flex', gap: '12px', alignItems: 'center'}}, [
                        e('a', {
                          href: `${service.repo_url.replace('.git', '')}/-/tree/${goldenBranch}`,
                          target: '_blank',
                          style: {color: 'var(--green)', textDecoration: 'none', fontWeight: '600'},
                          onMouseOver: (e) => e.target.style.textDecoration = 'underline',
                          onMouseOut: (e) => e.target.style.textDecoration = 'none'
                        }, '🔗 View in GitLab'),
                        e('span', {style: {color: 'var(--muted)', fontSize: '12px'}}, 'Opens in new tab')
              ])
            ])
          ]),
          
                  // Branch Statistics
                  e('div', {style: {display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px'}}, [
                    e('div', {style: {background: 'var(--chip)', padding: '16px', borderRadius: '8px'}}, [
                      e('div', {style: {fontSize: '24px', fontWeight: '700', color: 'var(--green)', marginBottom: '4px'}}, goldenBranches.length),
                      e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 'Golden Branches')
                    ]),
                    e('div', {style: {background: 'var(--chip)', padding: '16px', borderRadius: '8px'}}, [
                      e('div', {style: {fontSize: '24px', fontWeight: '700', color: 'var(--med)', marginBottom: '4px'}}, driftBranches.length),
                      e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 'Drift Branches')
                    ])
                  ]),
                  
                  // Recent Branches
                  e('div', {style: {marginBottom: '16px'}}, [
                    e('h4', {style: {margin: '0 0 12px 0'}}, 'Recent Drift Branches'),
                    driftBranches.length > 0 ? 
                      e('div', {style: {maxHeight: '200px', overflowY: 'auto'}}, 
                        driftBranches.slice(0, 5).map(branch => 
                          e('div', {key: branch, style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--line)'}}, [
                            e('span', {style: {fontFamily: 'monospace', fontSize: '12px'}}, branch),
                            e('a', {
                              href: `${service.repo_url.replace('.git', '')}/-/tree/${branch}`,
                              target: '_blank',
                              style: {color: 'var(--med)', textDecoration: 'none', fontSize: '12px'},
                              onMouseOver: (e) => e.target.style.textDecoration = 'underline',
                              onMouseOut: (e) => e.target.style.textDecoration = 'none'
                            }, 'View')
                          ])
                        )
                      ) :
                      e('div', {style: {color: 'var(--muted)', fontStyle: 'italic'}}, 'No drift branches yet')
                  ])
                ];
              })()
            ])
          ])
        ]);
      }
      
      function DeploymentTab({serviceId, currentEnvironment}) {
        const [driftData, setDriftData] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [selectedCategory, setSelectedCategory] = React.useState('all');
        
        // Load drift analysis data
        React.useEffect(() => {
          const loadDriftData = async () => {
            if (!serviceId) return;
            
            try {
              setLoading(true);
              const response = await fetch(`/api/services/${serviceId}/llm-output`);
              if (!response.ok) {
                throw new Error('No analysis results available. Run an analysis first.');
              }
              const data = await response.json();
              setDriftData(data.data || {});
              setError(null);
            } catch (err) {
              console.error('Error loading drift data:', err);
              setError(err.message);
              setDriftData(null);
            } finally {
              setLoading(false);
            }
          };
          
          loadDriftData();
        }, [serviceId]);
        
        // Get risk color
        const getRiskColor = (category) => {
          const colors = {
            'high': 'var(--red)',
            'medium': 'var(--yellow)',
            'low': 'var(--blue)',
            'allowed_variance': 'var(--green)'
          };
          return colors[category] || 'var(--muted)';
        };
        
        // Get risk badge
        const getRiskBadge = (category) => {
          const badges = {
            'high': { className: 'badge danger', text: '🔴 HIGH RISK' },
            'medium': { className: 'badge warning', text: '⚠️ MEDIUM RISK' },
            'low': { className: 'badge', text: '🔵 LOW RISK' },
            'allowed_variance': { className: 'badge success', text: '✅ ALLOWED' }
          };
          return badges[category] || { className: 'badge', text: category.toUpperCase() };
        };
        
        if (loading) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '24px', marginBottom: '16px'}}, '⏳'),
            e('div', null, 'Loading drift analysis...')
          ]);
        }
        
        if (error) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, '📭'),
            e('div', {style: {fontSize: '18px', marginBottom: '8px'}}, 'No Analysis Results'),
            e('div', {style: {color: 'var(--muted)', marginBottom: '16px'}}, error),
            e('div', {style: {marginTop: '24px'}}, [
              e('p', {style: {marginBottom: '12px'}}, 'Click "Analyze" button to run configuration drift detection'),
              e('button', {
                className: 'btn',
                onClick: () => window.location.reload()
              }, 'Refresh Page')
            ])
          ]);
        }
        
        if (!driftData) {
          return e('div', {className: 'card'}, e('div', null, 'No data available'));
        }
        
        // Get drift items by category
        const highRisk = driftData.high || [];
        const mediumRisk = driftData.medium || [];
        const lowRisk = driftData.low || [];
        const allowedVariance = driftData.allowed_variance || [];
        
        // Filter based on selected category
        const allDrifts = [
          ...highRisk.map(d => ({...d, category: 'high'})),
          ...mediumRisk.map(d => ({...d, category: 'medium'})),
          ...lowRisk.map(d => ({...d, category: 'low'})),
          ...allowedVariance.map(d => ({...d, category: 'allowed_variance'}))
        ];
        
        const filteredDrifts = selectedCategory === 'all' 
          ? allDrifts 
          : allDrifts.filter(d => d.category === selectedCategory);
        
        return e('div', {className: 'grid'}, [
          e('div', {className: 'card'}, [
            // Header with summary
            e('div', {style: {marginBottom: '24px'}}, [
              e('h3', {style: {margin: '0 0 16px 0'}}, 'Configuration Drift Analysis'),
              e('div', {style: {display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '12px'}}, [
                // High Risk Card
                e('div', {
                  style: {
                    padding: '12px',
                    background: highRisk.length > 0 ? '#ffebe9' : '#f5f5f5',
                    borderRadius: '6px',
                    borderLeft: `4px solid ${highRisk.length > 0 ? 'var(--red)' : '#ddd'}`
                  }
                }, [
                  e('div', {style: {fontSize: '24px', fontWeight: 'bold', color: 'var(--red)'}}, highRisk.length),
                  e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginTop: '4px'}}, 'High Risk')
                ]),
                
                // Medium Risk Card
                e('div', {
                  style: {
                    padding: '12px',
                    background: mediumRisk.length > 0 ? '#fff8e1' : '#f5f5f5',
                    borderRadius: '6px',
                    borderLeft: `4px solid ${mediumRisk.length > 0 ? 'var(--yellow)' : '#ddd'}`
                  }
                }, [
                  e('div', {style: {fontSize: '24px', fontWeight: 'bold', color: 'var(--yellow)'}}, mediumRisk.length),
                  e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginTop: '4px'}}, 'Medium Risk')
                ]),
                
                // Low Risk Card
                e('div', {
                  style: {
                    padding: '12px',
                    background: lowRisk.length > 0 ? '#e3f2fd' : '#f5f5f5',
                    borderRadius: '6px',
                    borderLeft: `4px solid ${lowRisk.length > 0 ? 'var(--blue)' : '#ddd'}`
                  }
                }, [
                  e('div', {style: {fontSize: '24px', fontWeight: 'bold', color: 'var(--blue)'}}, lowRisk.length),
                  e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginTop: '4px'}}, 'Low Risk')
                ]),
                
                // Allowed Variance Card
                e('div', {
                  style: {
                    padding: '12px',
                    background: allowedVariance.length > 0 ? '#e8f5e9' : '#f5f5f5',
                    borderRadius: '6px',
                    borderLeft: `4px solid ${allowedVariance.length > 0 ? 'var(--green)' : '#ddd'}`
                  }
                }, [
                  e('div', {style: {fontSize: '24px', fontWeight: 'bold', color: 'var(--green)'}}, allowedVariance.length),
                  e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginTop: '4px'}}, 'Allowed')
                ])
              ])
            ]),
            
            // Category filter buttons
            e('div', {style: {display: 'flex', gap: '8px', marginBottom: '20px', flexWrap: 'wrap'}}, [
              e('button', {
                className: `btn ${selectedCategory === 'all' ? 'success' : ''}`,
                style: {fontSize: '13px'},
                onClick: () => setSelectedCategory('all')
              }, `All (${allDrifts.length})`),
              e('button', {
                className: `btn ${selectedCategory === 'high' ? 'danger' : ''}`,
                style: {fontSize: '13px'},
                onClick: () => setSelectedCategory('high')
              }, `High (${highRisk.length})`),
              e('button', {
                className: `btn ${selectedCategory === 'medium' ? 'warning' : ''}`,
                style: {fontSize: '13px'},
                onClick: () => setSelectedCategory('medium')
              }, `Medium (${mediumRisk.length})`),
              e('button', {
                className: `btn ${selectedCategory === 'low' ? '' : ''}`,
                style: {fontSize: '13px'},
                onClick: () => setSelectedCategory('low')
              }, `Low (${lowRisk.length})`),
              e('button', {
                className: `btn ${selectedCategory === 'allowed_variance' ? 'success' : ''}`,
                style: {fontSize: '13px'},
                onClick: () => setSelectedCategory('allowed_variance')
              }, `Allowed (${allowedVariance.length})`)
            ]),
            
            // Drift items list
            filteredDrifts.length === 0 ? 
              e('div', {style: {textAlign: 'center', padding: '40px', color: 'var(--muted)'}}, 
                `No ${selectedCategory === 'all' ? '' : selectedCategory + ' '}drift items found`) :
              
              filteredDrifts.map((drift, index) => {
                const badge = getRiskBadge(drift.category);
                const riskColor = getRiskColor(drift.category);
                
                return e('div', {
                  key: drift.id || index,
                  className: 'commit-item',
                  style: {
                    borderLeft: `4px solid ${riskColor}`,
                    marginBottom: '12px'
                  }
                }, [
                  // Header
                  e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: '12px'}}, [
                    e('div', {style: {flex: 1}}, [
                      e('div', {style: {fontSize: '16px', fontWeight: '600', marginBottom: '4px'}}, 
                        drift.locator?.value || drift.file),
                      e('div', {style: {fontSize: '13px', color: 'var(--muted)'}}, 
                        `📄 ${drift.file}`)
                    ]),
                    e('span', {className: badge.className, style: {flexShrink: 0}}, badge.text)
                  ]),
                  
                  // Change details
                  e('div', {style: {display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '12px'}}, [
                    e('div', {style: {
                      padding: '8px',
                      background: '#ffebe9',
                      borderRadius: '4px',
                      fontSize: '13px'
                    }}, [
                      e('div', {style: {fontWeight: '600', marginBottom: '4px', color: 'var(--red)'}}, '- Old Value:'),
                      e('code', {style: {fontSize: '12px'}}, JSON.stringify(drift.old))
                    ]),
                    e('div', {style: {
                      padding: '8px',
                      background: '#e6ffed',
                      borderRadius: '4px',
                      fontSize: '13px'
                    }}, [
                      e('div', {style: {fontWeight: '600', marginBottom: '4px', color: 'var(--green)'}}, '+ New Value:'),
                      e('code', {style: {fontSize: '12px'}}, JSON.stringify(drift.new))
                    ])
                  ]),
                  
                  // Why & Impact
                  drift.why && e('div', {style: {marginBottom: '8px'}}, [
                    e('div', {style: {fontSize: '13px', fontWeight: '600', marginBottom: '4px'}}, '📝 What Changed:'),
                    e('div', {style: {fontSize: '13px', color: '#555'}}, drift.why)
                  ]),
                  
                  drift.impact && e('div', {style: {marginBottom: '8px'}}, [
                    e('div', {style: {fontSize: '13px', fontWeight: '600', marginBottom: '4px'}}, '⚠️ Impact:'),
                    e('div', {style: {fontSize: '13px', color: '#555'}}, drift.impact)
                  ]),
                  
                  // AI Review Assistant (if available)
                  drift.ai_review_assistant && e('div', {
                    style: {
                      marginTop: '12px',
                      padding: '12px',
                      background: '#fff8dc',
                      borderRadius: '6px',
                      border: '1px solid #ffe082'
                    }
                  }, [
                    e('div', {style: {fontSize: '13px', fontWeight: '600', marginBottom: '8px', color: '#f57c00'}}, 
                      '🤖 AI Review Assistant'),
                    
                    drift.ai_review_assistant.potential_risk && e('div', {style: {marginBottom: '8px'}}, [
                      e('div', {style: {fontSize: '12px', fontWeight: '600', marginBottom: '4px'}}, 'Potential Risk:'),
                      e('div', {style: {fontSize: '12px'}}, drift.ai_review_assistant.potential_risk)
                    ]),
                    
                    drift.ai_review_assistant.suggested_action && e('div', null, [
                      e('div', {style: {fontSize: '12px', fontWeight: '600', marginBottom: '4px'}}, 'Suggested Action:'),
                      e('div', {style: {fontSize: '12px'}}, drift.ai_review_assistant.suggested_action)
                    ])
                  ]),
                  
                  // Remediation snippet (if available)
                  drift.remediation?.snippet && e('div', {
                    style: {
                      marginTop: '12px',
                      padding: '8px',
                      background: '#f5f5f5',
                      borderRadius: '4px',
                      fontFamily: 'monospace',
                      fontSize: '12px'
                    }
                  }, [
                    e('div', {style: {fontWeight: '600', marginBottom: '4px'}}, '💡 Recommended Fix:'),
                    e('code', null, drift.remediation.snippet)
                  ])
                ]);
              })
          ])
        ]);
      }
      
      function CertificationsTab({issueData, onStagingClick, serviceConfig, serviceId, onCertificationUpdate}) {
        const [certifications, setCertifications] = React.useState({});
        const [loading, setLoading] = React.useState({});
        const [error, setError] = React.useState(null);
        
        // Load certification status for all environments
        React.useEffect(() => {
          const loadCertifications = async () => {
            if (!serviceConfig) return;
            
            // Get environments from service configuration (no hardcoded values)
            const environments = serviceConfig?.environments || ['prod', 'dev', 'qa', 'staging'];
            
            const certData = {};
            for (const env of environments) {
              try {
                const response = await fetch(`/api/services/${serviceId}/validate-golden/${env}`);
                const data = await response.json();
                certData[env] = data;
              } catch (err) {
                certData[env] = { golden_exists: false, error: err.message };
              }
            }
            setCertifications(certData);
          };
          loadCertifications();
        }, [serviceConfig, serviceId]);
        
        const handleCertify = async (environment) => {
          setLoading(prev => ({ ...prev, [environment]: true }));
          setError(null);
          
          try {
            const response = await fetch(`/api/services/${serviceId}/set-golden/${environment}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to certify ${environment}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Update certifications state
            setCertifications(prev => ({
              ...prev,
              [environment]: {
                golden_exists: true,
                active_golden_branch: result.branch_name,
                service_id: serviceId,
                environment: environment
              }
            }));
            
            // Trigger overview tab update
            if (onCertificationUpdate) {
              onCertificationUpdate();
            }
            
          } catch (err) {
            setError(`Failed to certify ${environment}: ${err.message}`);
          } finally {
            setLoading(prev => ({ ...prev, [environment]: false }));
          }
        };
        
        const handleRevoke = async (environment) => {
          setLoading(prev => ({ ...prev, [environment]: true }));
          setError(null);
          
          try {
            const response = await fetch(`/api/services/${serviceId}/revoke-golden/${environment}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to revoke ${environment}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Update certifications state
            setCertifications(prev => ({
              ...prev,
              [environment]: {
                golden_exists: false,
                active_golden_branch: null,
                service_id: serviceId,
                environment: environment
              }
            }));
            
            // Trigger overview tab update
            if (onCertificationUpdate) {
              onCertificationUpdate();
            }
            
          } catch (err) {
            setError(`Failed to revoke ${environment}: ${err.message}`);
          } finally {
            setLoading(prev => ({ ...prev, [environment]: false }));
          }
        };
        
        const getEnvironmentDisplayName = (env) => {
          const names = {
            'prod': 'Production',
            'dev': 'Development', 
            'qa': 'QA',
            'staging': 'Staging'
          };
          return names[env] || env;
        };
        
        const getEnvironmentColor = (env) => {
          const colors = {
            'prod': 'var(--ink)',
            'dev': 'var(--ink)',
            'qa': 'var(--ink)', 
            'staging': 'var(--ink)'
          };
          return colors[env] || 'var(--muted)';
        };
        
        return e('div', {className: 'card'}, [
          e('h3', {style: {margin: '0 0 20px 0'}}, 'Environment Certification & Golden Branches'),
          e('p', {style: {color: 'var(--muted)', margin: '0 0 24px 0'}}, 
            'Certify environments to create golden branches for drift analysis baseline'),
          
          // Error message
          error && e('div', {style: {background: 'var(--red-bg)', border: '1px solid var(--red)', borderRadius: '8px', padding: '12px', marginBottom: '16px', color: 'var(--red)'}}, 
            `❌ ${error}`
          ),
          
          // Environment certifications
          ...(() => {
            // Get environments from service config (dynamic, no hardcoded values)
            const environments = serviceConfig?.environments || [];
            return environments.map(env => {
            const cert = certifications[env] || {};
            const isCertified = cert.golden_exists;
            const isLoading = loading[env];
            
            return e('div', {key: env, className: 'env-cert'}, [
              // Top row: Environment name + Certified tag on left, buttons on far right
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}, [
                e('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}}, [
                  e('div', {className: 'env-name', style: {color: getEnvironmentColor(env)}}, 
                    getEnvironmentDisplayName(env)
                  ),
                  isCertified && e('span', {className: 'badge success'}, [
                    e('span', null, '✓'),
                'Certified'
            ])
          ]),
                e('div', {style: {display: 'flex', gap: '8px'}}, [
                  isCertified ? [
                    e('button', {
                      className: 'btn',
                      disabled: isLoading,
                      onClick: () => handleRevoke(env),
                      style: {backgroundColor: '#F3F4F6', color: '#111827', border: '1px solid #D1D5DB'}
                    }, [
                      e('span', {style: {marginRight: '6px'}}, '×'),
                      isLoading ? 'Revoking...' : 'Revoke'
                    ]),
                    e('button', {
                      className: 'btn',
                      disabled: isLoading,
                      onClick: () => handleCertify(env),
                      style: {backgroundColor: '#F3F4F6', color: '#111827', border: '1px solid #D1D5DB'}
                    }, [
                      e('span', {style: {marginRight: '6px'}}, '↻'),
                      isLoading ? 'Re-certifying...' : 'Re-certify'
                    ])
                  ] : [
                    e('button', {
                      className: 'btn',
                      disabled: isLoading,
                      onClick: () => handleCertify(env),
                      style: {backgroundColor: '#F3F4F6', color: '#111827', border: '1px solid #D1D5DB'}
                    }, isLoading ? 'Certifying...' : 'Certify')
                  ]
                ])
              ]),
              // Details below the environment name (not on the right)
              e('div', {style: {marginLeft: '0'}}, [
                isCertified ? [
                  e('div', {className: 'env-details'}, 
                    `Golden Branch: ${cert.active_golden_branch || 'Unknown'}`
                  ),
                  e('div', {className: 'env-details'}, 
                    `Certified and ready for drift analysis`
                  )
                ] : [
                  e('div', {className: 'env-details'}, 
                    'No golden branch found - certification required'
                  ),
                  e('div', {className: 'env-details'}, 
                    'Click "Certify" to create golden baseline'
                  )
                ]
              ])
            ]);
          });
          })()
        ]);
      }
      
      function HistoryTab({serviceId, currentEnvironment}) {
        const [runHistory, setRunHistory] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [selectedEnv, setSelectedEnv] = React.useState(currentEnvironment || 'prod');
        
        // Load run history from API
        React.useEffect(() => {
          const loadRunHistory = async () => {
            if (!serviceId || !selectedEnv) return;
            
            try {
              setLoading(true);
              const response = await fetch(`/api/services/${serviceId}/run-history/${selectedEnv}`);
              if (!response.ok) throw new Error('Failed to load run history');
              const data = await response.json();
              setRunHistory(data.runs || []);
              setError(null);
            } catch (err) {
              console.error('Error loading run history:', err);
              setError(err.message);
              setRunHistory([]);
            } finally {
              setLoading(false);
            }
          };
          
          loadRunHistory();
        }, [serviceId, selectedEnv]);
        
        // Format timestamp
        const formatTimestamp = (isoString) => {
          try {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch {
            return isoString;
          }
        };
        
        // Get verdict badge configuration
        const getVerdictBadge = (verdict) => {
          const configs = {
            'PASS': { className: 'badge success', text: '✅ PASS' },
            'WARN': { className: 'badge warning', text: '⚠️ WARN' },
            'REVIEW_REQUIRED': { className: 'badge warning', text: '🔍 REVIEW' },
            'BLOCK': { className: 'badge danger', text: '🚫 BLOCK' },
            'COMPLETED': { className: 'badge success', text: '✅ COMPLETED' }
          };
          return configs[verdict] || { className: 'badge', text: verdict };
        };
        
        // Handle click to view run details
        const handleViewRun = (run) => {
          window.location.href = `/service/${serviceId}?run_id=${run.run_id}&env=${selectedEnv}`;
        };
        
        if (loading) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '24px', marginBottom: '16px'}}, '⏳'),
            e('div', null, 'Loading analysis history...')
          ]);
        }
        
        if (error) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '24px', marginBottom: '16px', color: 'var(--red)'}}, '❌'),
            e('div', null, `Error: ${error}`),
            e('button', {
              className: 'btn',
              style: {marginTop: '16px'},
              onClick: () => window.location.reload()
            }, 'Retry')
          ]);
        }
        
        if (runHistory.length === 0) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, '📭'),
            e('div', {style: {fontSize: '18px', marginBottom: '8px'}}, 'No analysis runs yet'),
            e('div', {style: {color: 'var(--muted)', marginTop: '8px'}}, 
              `Run an analysis for ${selectedEnv} environment to see results here`)
          ]);
        }
        
        return e('div', {className: 'card'}, [
          e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}, [
            e('h3', {style: {margin: '0'}}, `Analysis History (${runHistory.length} runs)`),
            e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 
              `Environment: ${selectedEnv.toUpperCase()}`)
          ]),
          
          // Run list
          runHistory.map((run, index) => {
            const badge = getVerdictBadge(run.verdict);
            const metrics = run.metrics || {};
            const branches = run.branches || {};
            
            return e('div', {
              key: run.run_id || index,
              className: 'commit-item',
              style: {
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                borderLeft: `4px solid ${
                  run.verdict === 'PASS' ? 'var(--green)' :
                  run.verdict === 'WARN' ? 'var(--yellow)' :
                  run.verdict === 'BLOCK' ? 'var(--red)' :
                  'var(--blue)'
                }`
              },
              onClick: () => handleViewRun(run),
              onMouseEnter: (e) => {
                e.currentTarget.style.background = '#f8f9fa';
                e.currentTarget.style.transform = 'translateX(4px)';
              },
              onMouseLeave: (e) => {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.transform = 'translateX(0)';
              }
            }, [
              // Header row - Run number and verdict
              e('div', {style: {display: 'flex', justifyContent: 'space-between', marginBottom: '8px', alignItems: 'center'}}, [
                e('div', null, [
                  e('strong', {style: {fontSize: '16px'}}, `Run #${runHistory.length - index}`),
                  e('span', {style: {color: 'var(--muted)', marginLeft: '12px', fontSize: '14px'}}, 
                    formatTimestamp(run.timestamp))
                ]),
                e('span', {className: badge.className}, badge.text)
              ]),
              
              // Metrics row
              e('div', {className: 'commit-meta', style: {marginBottom: '8px'}}, [
                `${metrics.files_with_drift || 0} files drifted • `,
                `${metrics.total_deltas || 0} changes • `,
                `${metrics.policy_violations || 0} violations • `,
                `Risk: ${metrics.overall_risk_level || 'unknown'}`
              ]),
              
              // Branches info
              e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginBottom: '4px'}}, [
                `Golden: ${branches.golden_branch || 'N/A'}`
              ]),
              e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginBottom: '8px'}}, [
                `Drift: ${branches.drift_branch || 'N/A'}`
              ]),
              
              // Execution time
              e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginBottom: '8px'}}, [
                `⏱️ Execution time: ${run.execution_time_seconds ? run.execution_time_seconds.toFixed(1) : 'N/A'}s`
              ]),
              
              // View link
              e('div', {
                style: {
                  marginTop: '8px',
                  color: 'var(--primary)',
                  fontSize: '14px',
                  fontWeight: '500',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '4px'
                }
              }, [
                e('span', null, '→ Click to view detailed analysis'),
                e('span', {style: {fontSize: '12px', color: 'var(--muted)'}}, `(${run.run_id.substring(0, 30)}...)`)
              ])
            ]);
          })
        ]);
      }
      
      function StagingModal({onClose, onPromote, onReview, issueData}) {
        return e('div', {className: 'modal-overlay', onClick: onClose}, [
          e('div', {className: 'modal', onClick: (e) => e.stopPropagation()}, [
            e('h3', null, '🔄 Staging Environment Actions'),
            e('p', null, `Manage staging deployment for ${serviceConfig?.name || serviceId}`),
            e('p', {style: {color: 'var(--yellow)'}}, 'Current Status: Pending Certification Review'),
            
            e('div', {style: {background: '#fff8dc', padding: '12px', borderRadius: '8px', margin: '16px 0'}}, [
              e('strong', null, 'Available Actions:'),
              e('ul', {style: {margin: '8px 0 0 0'}}, [
                e('li', null, 'Promote changes to staging for testing'),
                e('li', null, 'Request security team review'),
                e('li', null, 'Schedule certification review meeting')
              ])
            ]),
            
            e('div', {className: 'modal-actions'}, [
              e('button', {className: 'btn', onClick: onClose}, 'Cancel'),
              e('button', {className: 'btn warning', onClick: onReview}, 'Request Review'),
              e('button', {className: 'btn success', onClick: onPromote}, 'Promote to Staging')
            ])
          ])
        ]);
      }
      
      ReactDOM.createRoot(document.getElementById('root')).render(e(BranchEnvironmentPage));
    })();
  </script>
</body>
</html>