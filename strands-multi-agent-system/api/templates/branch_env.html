<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Branch & Environment Tracking - Golden Config AI</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <style>
    :root{
      --vz-red:#B91C1C; --med:#D97706; --low:#4B5563; --allowed: #6B7280;
      --ink:#111827; --muted:#6B7280; --bg:#F9FAFB;
      --panel:#FFFFFF; --line:#E5E7EB; --chip:#F3F4F6;
      --shadow:0 4px 6px -1px rgba(0,0,0,.07), 0 2px 4px -2px rgba(0,0,0,.07);
      --success: #059669; --success-bg: #ECFDF5;
      --green: #059669; --green-bg: #ECFDF5;
      --yellow: #6B7280; --yellow-bg: #F3F4F6;
      --red: #6B7280; --red-bg: #F3F4F6;
    }
    *{box-sizing:border-box}
    html,body,#root{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    .container{max-width:1400px;margin:0 auto;padding:24px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:24px}
    .btn{border:1px solid #D1D5DB;background:#FFFFFF;color:#374151;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;}
    .btn:hover{background-color:#F9FAFB;}
    .btn.primary{background: #4B5563; color: white; border-color: #4B5563;}
    .btn.success{background: #4B5563; color: white; border-color: #4B5563;}
    .btn.warning{background: #6B7280; color: white; border-color: #6B7280;}
    .btn.danger{background: #6B7280; color: white; border-color: #6B7280;}
    
    .header{margin-bottom:32px}
    .back-btn{margin-bottom:16px}
    .title{font-size:24px;font-weight:700;margin:0 0 8px 0;display:flex;align-items:center;gap:12px}
    .subtitle{color:var(--muted);margin:0}
    
    .issue-alert{background:var(--red-bg);border:2px solid var(--red);border-radius:12px;padding:16px;margin-bottom:24px}
    .issue-alert h3{color:var(--red);margin:0 0 8px 0;font-size:18px}
    .issue-alert p{margin:0;color:#7F1D1D}
    
    .tabs{display:flex;background:var(--chip);border-radius:12px;padding:4px;margin-bottom:24px}
    .tab{flex:1;padding:12px 24px;border-radius:8px;background:transparent;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
    .tab.active{background:var(--panel);box-shadow:var(--shadow)}
    
    .grid{display:grid;gap:24px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    
    .status-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .status-item:last-child{margin-bottom:0}
    .status-label{color:var(--muted)}
    .status-value{font-weight:600;display:flex;align-items:center;gap:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px}
    
    .badge{display:inline-flex;align-items:center;padding:6px 16px;border-radius:999px;font-size:12px;font-weight:700;gap:6px;cursor:pointer;transition:all 0.2s}
    .badge:hover{transform:scale(1.05)}
    .badge.success{background:var(--success-bg);color:var(--success);border:1px solid var(--success)}
    .badge.warning{background:var(--yellow-bg);color:var(--yellow);border:1px solid var(--yellow)}
    .badge.danger{background:var(--red-bg);color:var(--red);border:1px solid var(--red)}
    .badge.production{background:var(--chip);color:var(--ink);border:1px solid var(--line)}
    
    .commit-item{padding:16px;border:1px solid var(--line);border-radius:12px;margin-bottom:12px}
    .commit-item:last-child{margin-bottom:0}
    .commit-hash{font-family:monospace;background:var(--chip);padding:4px 8px;border-radius:6px;font-size:12px}
    .commit-meta{color:var(--muted);font-size:13px;margin-top:4px}
    
    .env-cert{display:block;padding:16px 0;border-bottom:1px solid var(--line)}
    .env-cert:last-child{border-bottom:none}
    .env-name{font-weight:600;font-size:16px}
    .env-details{color:var(--muted);font-size:13px;margin-top:4px}
    
    .deployment-actions{margin-top:12px;display:flex;gap:8px}
    
    /* Drift Analysis Tab Styles (from index.html) */
    .stats{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
    .stat{text-align:center;padding:20px 16px;min-height:100px;display:flex;flex-direction:column;justify-content:center}
    .stat .val{font-size:28px;font-weight:700;line-height:1.1;margin-bottom:4px}
    .stat .lbl{font-size:14px;color:var(--muted);font-weight:600;line-height:1.2}
    .stat.clickable{transition: all 0.2s ease; transform: scale(1); cursor:pointer;}
    .stat.clickable:hover{transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
    
    .issue-card{padding: 0;}
    .issue-header{display:flex; justify-content: space-between; align-items: center; gap: 16px; padding: 16px; cursor: pointer; border-radius: 16px; transition: background-color 0.2s;}
    .issue-header:hover{background-color: #FAFAFA;}
    .issue-summary{flex: 1;}
    .issue-details{padding: 16px; display: flex; flex-direction: column; gap: 16px; border-top: 1px solid var(--line);}
    .details-actions{display: flex; justify-content: flex-end; gap: 8px;}
    
    .issue-meta{display: flex; flex-wrap: wrap; align-items:center; gap:8px; margin-top: 8px;}
    .churn-pill{font-weight: 600; font-size: 12px;}
    .churn-pill .add{color: #00796B;}
    .churn-pill .del{color: #C62828;}
    
    .pii-notice { color: #B45309; background: #FFFBEB; border-color: #FDE68A; }
    
    .insight-card{background: #FEFCE8; border-left: 4px solid #FBBF24; padding: 12px; border-radius: 8px;}
    .insight-card .heading{font-weight: 700; font-size: 1em; color: #92400E; margin-bottom: 4px;}
    
    .diff-view{border:1px solid var(--line);border-radius:12px;max-height:350px;overflow:auto;}
    .diff-line{padding: 4px 12px; white-space:pre-wrap; border-left: 3px solid transparent; font-family:monospace; font-size:13px;}
    .diff-line.hdr{background:#F3F4F6; color: var(--muted); font-style: italic;}
    .diff-line.add{background:#E0F2F1; border-left-color: #00796B;}
    .diff-line.del{background:#FFEBEE; border-left-color: #C62828;}
    
    .toggle-btn{
        background: var(--chip);
        border: 1px solid var(--line);
        color: var(--muted);
        cursor: pointer;
        width: 28px;
        height: 28px;
        border-radius: 999px;
        font-size: 20px;
        line-height: 26px;
        text-align: center;
        transition: background-color 0.2s, transform 0.2s;
        font-weight: 500;
    }
    .toggle-btn:hover{ background-color: #E5E7EB; }
    .toggle-btn.open{ transform: rotate(45deg); }
    
    .grid-issues{display:grid;gap:16px}
    .section-title{font-size: 1.5em; font-weight: 700; margin-bottom: 16px; padding-bottom: 8px;}
    .success-banner{background:#ECFDF5;border:1px solid #059669;color:#065F46;padding:16px;border-radius:12px;margin-bottom:16px;}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid var(--line);border-top-color:var(--vz-red);border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Modal styles */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal{background:white;border-radius:16px;padding:24px;max-width:500px;width:90%;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 16px 0;color:var(--ink)}
    .modal p{margin:0 0 16px 0;color:var(--muted)}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/javascript">
    (function(){
      const e = React.createElement;
      
      function BranchEnvironmentPage() {
        const [activeTab, setActiveTab] = React.useState('overview');
        const [showStagingModal, setShowStagingModal] = React.useState(false);
        const [serviceConfig, setServiceConfig] = React.useState(null);
        const [certificationUpdateTrigger, setCertificationUpdateTrigger] = React.useState(0);
        
        // Get URL parameters to identify the service
        const urlParams = new URLSearchParams(window.location.search);
        const serviceId = urlParams.get('id') || 'unknown';
        
        // Note: Removed 'file' parameter as it was unused placeholder code
        
        // Load service configuration
        React.useEffect(() => {
          const loadServiceConfig = async () => {
            try {
              const servicesResponse = await fetch('/api/services');
              const servicesData = await servicesResponse.json();
              const service = servicesData.services.find(s => s.id === serviceId);
              setServiceConfig(service);
            } catch (err) {
              console.error('Failed to load service config:', err);
            }
          };
          loadServiceConfig();
        }, [serviceId]);
        
        // Mock issue data - in real app, this would be fetched from API
        const issueData = {
          id: serviceId,
          riskLevel: 'high', // Could be high, medium, low, allowed
          description: `Configuration drift detected for ${serviceConfig?.name || serviceId}`,
          affectedEnvironments: ['production', 'staging'],
          currentBranch: 'main',
          deployedBranch: 'main',
          lastCommit: 'a1b2c3d4'
        };
        
        function goBack() {
          window.history.back();
        }
        
        function handleStagingClick() {
          setShowStagingModal(true);
        }
        
        function handlePromoteToStaging() {
          alert('Promoting changes to staging environment...');
          setShowStagingModal(false);
        }
        
        function handleReviewStaging() {
          alert('Opening staging review workflow...');
          setShowStagingModal(false);
        }
        
        function triggerCertificationUpdate() {
          setCertificationUpdateTrigger(prev => prev + 1);
        }
        
        return e('div', {className: 'container'}, [
          // Header
          e('div', {className: 'header'}, [
            e('div', {style: {marginBottom: '16px'}}, [
            e('button', {className: 'btn back-btn', onClick: goBack}, [
              e('span', null, '‚Üê'),
              'Back to Issues'
              ])
            ]),
            e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '8px'}}, [
              e('div', null, [
                e('h1', {className: 'title', style: {marginBottom: '8px'}}, [
                  e('span', null, '‚öô'),
                  `Branch & Environment - ${serviceConfig?.name || 'Service'}`
                ]),
                e('p', {className: 'subtitle'}, `Track git branches, deployments, and environment-specific certifications`)
              ]),
              e('button', {
                className: 'btn',
                onClick: () => {
                  // Trigger analysis - you can customize this
                  window.location.href = `/service/${serviceId}`;
                },
                style: {marginLeft: '16px', backgroundColor: '#4B5563', color: 'white', border: '1px solid #4B5563'}
              }, '‚ñ∂Ô∏è Analyze')
            ])
          ]),
          
          // Risk banner removed from Overview tab as requested
          
          // Tabs
          e('div', {className: 'tabs'}, [
            e('button', {
              className: `tab ${activeTab === 'overview' ? 'active' : ''}`,
              onClick: () => setActiveTab('overview')
            }, 'Overview'),
            e('button', {
              className: `tab ${activeTab === 'certifications' ? 'active' : ''}`,
              onClick: () => setActiveTab('certifications')
            }, 'Certifications'),
            e('button', {
              className: `tab ${activeTab === 'deployment' ? 'active' : ''}`,
              onClick: () => setActiveTab('deployment')
            }, 'Drift Analysis'),
            e('button', {
              className: `tab ${activeTab === 'history' ? 'active' : ''}`,
              onClick: () => setActiveTab('history')
            }, 'Analysis History')
          ]),
          
          // Tab Content (reordered to match tab order)
          activeTab === 'overview' && e(OverviewTab, {issueData, onStagingClick: handleStagingClick, serviceConfig, serviceId, certificationUpdateTrigger}),
          activeTab === 'certifications' && e(CertificationsTab, {issueData, onStagingClick: handleStagingClick, serviceConfig, serviceId, onCertificationUpdate: triggerCertificationUpdate}),
          activeTab === 'deployment' && e(DeploymentTab, {serviceId, currentEnvironment: 'prod'}),
          activeTab === 'history' && e(HistoryTab, {serviceId, currentEnvironment: 'prod'}),
          
          // Staging Modal
          showStagingModal && e(StagingModal, {
            onClose: () => setShowStagingModal(false),
            onPromote: handlePromoteToStaging,
            onReview: handleReviewStaging,
            issueData
          })
        ]);
      }
      
      function OverviewTab({issueData, onStagingClick, serviceConfig, serviceId, certificationUpdateTrigger}) {
        const [branchStatus, setBranchStatus] = React.useState({});
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [selectedEnv, setSelectedEnv] = React.useState(null);
        const [showBranchDetails, setShowBranchDetails] = React.useState(false);
        
        // Load branch status for all environments
        React.useEffect(() => {
          const loadBranchData = async () => {
            if (!serviceConfig) return;
            
            try {
              // Get environments from service configuration (no hardcoded values)
              const environments = serviceConfig?.environments || ['prod', 'dev', 'qa', 'staging'];
              
              // Load branch status for all environments
              const statusData = {};
              for (const env of environments) {
                try {
                  const response = await fetch(`/api/services/${serviceId}/branches/${env}`);
                  const data = await response.json();
                  statusData[env] = data;
                } catch (err) {
                  statusData[env] = { error: err.message };
                }
              }
              setBranchStatus(statusData);
              
            } catch (err) {
              setError(`Failed to load data: ${err.message}`);
            } finally {
              setLoading(false);
            }
          };
          loadBranchData();
        }, [serviceConfig, serviceId, certificationUpdateTrigger]);
        
        const handleEnvClick = (env) => {
          const status = branchStatus[env];
          if (status && status.active_golden_branch) {
            setSelectedEnv(env);
            setShowBranchDetails(true);
          }
        };
        
        const closeBranchDetails = () => {
          setShowBranchDetails(false);
          setSelectedEnv(null);
        };
        
        const getEnvironmentDisplayName = (env) => {
          const names = {
            'prod': 'Production',
            'dev': 'Development', 
            'qa': 'QA',
            'staging': 'Staging'
          };
          return names[env] || env;
        };
        
        const getEnvironmentColor = (env) => {
          const colors = {
            'prod': 'var(--ink)',
            'dev': 'var(--ink)',
            'qa': 'var(--ink)', 
            'staging': 'var(--ink)'
          };
          return colors[env] || 'var(--muted)';
        };
        
        return e('div', {className: 'grid grid-2'}, [
          // Environment Status Overview (moved to left)
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0', fontSize: '18px'}}, 'Environment Certification Status'),
            
            error ? e('div', {style: {color: 'var(--red)', padding: '12px', background: 'var(--red-bg)', borderRadius: '8px', marginBottom: '16px'}}, 
              `‚ùå ${error}`
            ) : null,
            
            loading ? e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Loading environment data...') :
            (() => {
              // Get environments from service config (dynamic, no hardcoded values)
              const environments = serviceConfig?.environments || [];
              
              if (environments.length === 0) {
                return e('div', {style: {textAlign: 'center', padding: '40px 20px', color: 'var(--muted)'}}, [
                  e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, '‚öô'),
                  e('div', {style: {fontSize: '16px', fontWeight: '600', marginBottom: '8px'}}, 'No Environments Configured'),
                  e('div', {style: {fontSize: '14px'}}, 'Check service configuration')
                ]);
              }
              
              return environments.map(env => {
                const status = branchStatus[env] || {};
                const hasGolden = status.active_golden_branch;
                const goldenCount = status.total_golden || 0;
                const driftCount = status.total_drift || 0;
                const isCertified = hasGolden;
                
                return e('div', {
                  key: env, 
                  className: 'env-cert',
                  style: {cursor: isCertified ? 'pointer' : 'default', transition: 'all 0.2s'},
                  onClick: () => isCertified && handleEnvClick(env)
                }, [
                  e('div', null, [
                    e('div', {className: 'env-name', style: {color: getEnvironmentColor(env)}}, 
                      getEnvironmentDisplayName(env)
                    ),
                    e('div', {className: 'env-details'}, 
                      `Golden: ${hasGolden || 'None'}`
                    ),
                    e('div', {className: 'env-details'}, 
                      `${goldenCount} golden, ${driftCount} drift branches`
                    ),
                    isCertified && e('div', {className: 'env-details', style: {color: 'var(--muted)', fontSize: '12px', marginTop: '4px'}}, 
                      'Click to view details ‚Üí'
                    )
                  ]),
                  e('div', {style: {display: 'flex', alignItems: 'center', gap: '8px'}}, [
                    isCertified && e('span', {className: 'badge success'}, [
                      e('span', null, '‚úì'),
                      'Certified'
                    ])
                  ])
                ]);
              });
            })()
          ]),
          
          // Service Overview Card (moved to right)
          e('div', {className: 'card'}, [
            e('h3', {style: {margin: '0 0 20px 0', fontSize: '18px'}}, 'Service Overview'),
            
            error ? e('div', {style: {color: 'var(--red)', padding: '12px', background: 'var(--red-bg)', borderRadius: '8px', marginBottom: '16px'}}, 
              `‚ùå ${error}`
            ) : null,
            
            loading ? e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Loading service data...') :
            serviceConfig ? [
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Service:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, '‚öô'),
                  e('span', {className: 'mono'}, serviceConfig.name || serviceId)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Service ID:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ID'),
                  e('span', {className: 'mono'}, serviceId)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Main Branch:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'BR'),
                  e('span', {className: 'mono'}, serviceConfig.main_branch || 'main')
              ])
            ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Environments:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'ENV'),
                  e('span', null, `${serviceConfig.environments ? serviceConfig.environments.length : 0} configured`)
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Repository:'),
                e('div', {className: 'status-value'}, [
                  e('span', null, 'REPO'),
                  e('span', {style: {fontSize: '12px', wordBreak: 'break-all'}}, serviceConfig.repo_url || 'Unknown')
                ])
              ]),
              e('div', {className: 'status-item'}, [
                e('span', {className: 'status-label'}, 'Status:'),
                e('span', {className: serviceConfig.status === 'warning' ? 'badge warning' : 'badge success'}, 
                  serviceConfig.status === 'warning' ? '‚ö† Warning' : '‚úì Active'
                )
              ])
            ] : e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Service not found')
          ]),
          
          // Branch Details Popup
          showBranchDetails && selectedEnv && e('div', {className: 'modal-overlay', onClick: closeBranchDetails}, [
            e('div', {className: 'modal', onClick: (e) => e.stopPropagation()}, [
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}, [
                e('h3', {style: {margin: 0, fontSize: '20px'}}, [
                  e('span', {style: {marginRight: '8px'}}, '‚öô'),
                  `${getEnvironmentDisplayName(selectedEnv)} - Branch Details`
                ]),
                e('button', {
                  onClick: closeBranchDetails,
                  style: {background: 'none', border: 'none', fontSize: '24px', cursor: 'pointer', color: 'var(--muted)'}
                }, '√ó')
              ]),
              
              (() => {
                const status = branchStatus[selectedEnv] || {};
                const goldenBranch = status.active_golden_branch;
                const goldenBranches = status.golden_branches || [];
                const driftBranches = status.drift_branches || [];
                const service = serviceConfig;
                
                if (!service) {
                  return e('div', {style: {textAlign: 'center', padding: '20px', color: 'var(--muted)'}}, 'Service data not available');
                }
                
                return [
                  // Current Golden Branch
                  e('div', {style: {marginBottom: '24px'}}, [
                    e('h4', {style: {margin: '0 0 12px 0', color: 'var(--green)'}}, 'Active Golden Branch'),
                    e('div', {style: {background: 'var(--green-bg)', padding: '16px', borderRadius: '8px', border: '1px solid var(--green)'}}, [
                      e('div', {style: {fontFamily: 'monospace', fontSize: '14px', fontWeight: '600', marginBottom: '8px'}}, goldenBranch),
                      e('div', {style: {display: 'flex', gap: '12px', alignItems: 'center'}}, [
                        e('a', {
                          href: `${service.repo_url.replace('.git', '')}/-/tree/${goldenBranch}`,
                          target: '_blank',
                          style: {color: 'var(--green)', textDecoration: 'none', fontWeight: '600'},
                          onMouseOver: (e) => e.target.style.textDecoration = 'underline',
                          onMouseOut: (e) => e.target.style.textDecoration = 'none'
                        }, 'üîó View in GitLab'),
                        e('span', {style: {color: 'var(--muted)', fontSize: '12px'}}, 'Opens in new tab')
              ])
            ])
          ]),
          
                  // Branch Statistics
                  e('div', {style: {display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px', marginBottom: '24px'}}, [
                    e('div', {style: {background: 'var(--chip)', padding: '16px', borderRadius: '8px'}}, [
                      e('div', {style: {fontSize: '24px', fontWeight: '700', color: 'var(--green)', marginBottom: '4px'}}, goldenBranches.length),
                      e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 'Golden Branches')
                    ]),
                    e('div', {style: {background: 'var(--chip)', padding: '16px', borderRadius: '8px'}}, [
                      e('div', {style: {fontSize: '24px', fontWeight: '700', color: 'var(--med)', marginBottom: '4px'}}, driftBranches.length),
                      e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 'Drift Branches')
                    ])
                  ]),
                  
                  // Recent Branches
                  e('div', {style: {marginBottom: '16px'}}, [
                    e('h4', {style: {margin: '0 0 12px 0'}}, 'Recent Drift Branches'),
                    driftBranches.length > 0 ? 
                      e('div', {style: {maxHeight: '200px', overflowY: 'auto'}}, 
                        driftBranches.slice(0, 5).map(branch => 
                          e('div', {key: branch, style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px 0', borderBottom: '1px solid var(--line)'}}, [
                            e('span', {style: {fontFamily: 'monospace', fontSize: '12px'}}, branch),
                            e('a', {
                              href: `${service.repo_url.replace('.git', '')}/-/tree/${branch}`,
                              target: '_blank',
                              style: {color: 'var(--med)', textDecoration: 'none', fontSize: '12px'},
                              onMouseOver: (e) => e.target.style.textDecoration = 'underline',
                              onMouseOut: (e) => e.target.style.textDecoration = 'none'
                            }, 'View')
                          ])
                        )
                      ) :
                      e('div', {style: {color: 'var(--muted)', fontStyle: 'italic'}}, 'No drift branches yet')
                  ])
                ];
              })()
            ])
          ])
        ]);
      }
      
      // ============================================================================
      // DRIFT ANALYSIS TAB HELPER COMPONENTS (Copied from index.html)
      // ============================================================================
      
      const MASKING_PATTERNS = [
          { regex: /(PASSWORD|SECRET|KEY|TOKEN)\s*[:=]\s*([^\s]+)/gi, replacement: "$1: '********'" },
          { regex: /(AES:)[^\s]+/gi, replacement: "$1********" }
      ];

      function maskPII(text) {
          if (typeof text !== 'string') return '';
          let maskedText = text;
          MASKING_PATTERNS.forEach(({ regex, replacement }) => { maskedText = maskedText.replace(regex, replacement); });
          return maskedText;
      }

      function hasPII(text) {
          if (typeof text !== 'string') return false;
          return MASKING_PATTERNS.some(({ regex }) => { regex.lastIndex = 0; return regex.test(text); });
      }

      function getChangeType(item) {
        if (item.drift_category) return item.drift_category;
        const { file, why = '' } = item;
        if (why.includes('dependency')) return 'Dependency';
        if (file.endsWith('.yml') || file.endsWith('.properties') || why.includes('connection string')) return 'Configuration';
        if (file.endsWith('pom.xml') || file.startsWith('helm/')) return 'Build & Deployment';
        if (why.includes('probe') || why.includes('security') || why.includes('password')) return 'Security & Health';
        if (file.endsWith('.java')) return 'Code Logic';
        return 'General';
      }

      function generateInsight(item) {
          if (item.ai_review_assistant && item.ai_review_assistant.potential_risk && item.ai_review_assistant.suggested_action) {
              return e('div', {className: 'insight-card'}, [
                e('div', {className: 'heading'}, 'üí° AI Review Assistant'),
                e('p', {style: {margin: 0}}, [ 
                  e('strong', null, 'Potential Risk: '), 
                  maskPII(item.ai_review_assistant.potential_risk), 
                  e('br'), 
                  e('strong', null, 'Suggested Action: '), 
                  maskPII(item.ai_review_assistant.suggested_action) 
                ])
              ]);
          }
          const { why = '', remediation = {} } = item;
          if (why) {
              const remediationText = remediation.snippet || 
                                     (remediation.steps && Array.isArray(remediation.steps) 
                                       ? remediation.steps.join('; ') 
                                       : 'Review and verify this configuration change.');
              return e('div', {className: 'insight-card'}, [
                e('div', {className: 'heading'}, 'üí° AI Review Assistant'),
                e('p', {style: {margin: 0}}, [ 
                  e('strong', null, 'Potential Risk: '), maskPII(why), 
                  e('br'), 
                  e('strong', null, 'Suggested Action: '), maskPII(remediationText) 
                ])
              ]);
          }
          return e('div', {className: 'insight-card'}, [
            e('div', {className: 'heading'}, 'üí° AI Review Assistant'),
            e('p', {style: {margin: 0}}, [ 
              e('strong', null, 'Potential Risk: '), 'N/A', 
              e('br'), 
              e('strong', null, 'Suggested Action: '), 'Review the change details below.' 
            ])
          ]);
      }

      const PIINotice = () => e('span', {className: 'chip pii-notice'}, 'üîí PII Masked');
      
      const LocatorPill = ({loc}) => {
          if(!loc) return null;
          let text = '';
          if (loc.type === 'unidiff' && loc.old_start) { text = `Lines ${loc.old_start} ‚Üí ${loc.new_start || loc.old_start}`; } 
          else if (loc.line_start) { text = `Line ${loc.line_start}`; } 
          else { text = loc.type || 'General'; }
          return e('span',{className:'chip mono'}, text);
      };

      const Churn = ({ loc }) => {
        if (loc.type !== 'unidiff' || loc.old_lines === undefined) return null;
        const netChange = (loc.new_lines || 0) - (loc.old_lines || 0);
        const additions = Math.max(0, netChange);
        const deletions = Math.max(0, -netChange);
        return e('span', {className: 'chip mono churn-pill'}, [ 
          e('span', {className: 'add'}, `+${additions} `), 
          e('span', {className: 'del'}, `-${deletions}`) 
        ]);
      };
      
      const CodeHunkIssue = ({ item }) => {
        const uiPatch = React.useMemo(() => item.remediation?.patch_hint?.replace(/\\n/g, '\n') || '', [item]);
        const lines = uiPatch.split('\n').filter(ln => !ln.startsWith('---') && !ln.startsWith('+++') && !ln.startsWith('diff --git'));
        return e('div', {className: 'diff-view mono'}, lines.map((ln, i) => 
          e('div', {
            key: i, 
            className: `diff-line ${ln.startsWith('@@')?'hdr':ln.startsWith('+')?'add':ln.startsWith('-')?'del':'ctx'}`
          }, maskPII(ln))
        ));
      };

      const ConfigChangeIssue = ({ item }) => {
        const { old = null, new: newVal = null, remediation = {}, locator = {} } = item;
        const elements = [];
        
        const showSmartDiff = () => {
          const maskedOld = maskPII(String(old || ''));
          const maskedNew = maskPII(String(newVal || ''));
          const isLargeBlock = maskedOld.length > 200 || maskedNew.length > 200;
          
          if (isLargeBlock && locator.value) {
            return e('div', { key: 'change' }, [
              e('div', { style: {marginBottom: '8px', color: '#666', fontSize: '13px'} }, 
                `üìç Changed field: ${locator.value}`
              ),
              e('div', { className: 'diff-view mono' }, [
                e('div', { key: 'old', className: 'diff-line del' }, `- ${maskedOld.substring(0, 150)}...`),
                e('div', { key: 'new', className: 'diff-line add' }, `+ ${maskedNew.substring(0, 150)}...`)
              ])
            ]);
          } else {
            return e('div', { key: 'change', className: 'diff-view mono' }, [
              maskedOld && e('div', { key: 'old', className: 'diff-line del' }, `- ${maskedOld}`),
              maskedNew && e('div', { key: 'new', className: 'diff-line add' }, `+ ${maskedNew}`)
            ].filter(Boolean));
          }
        };
        
        if (old !== null || newVal !== null) {
          elements.push(showSmartDiff());
        }
        
        if (remediation.steps && Array.isArray(remediation.steps) && remediation.steps.length > 0) {
          elements.push(
            e('div', { key: 'steps', style: {marginTop: '12px'} }, [
              e('strong', null, 'üîß Remediation Steps:'),
              e('ol', { style: {margin: '8px 0', paddingLeft: '20px'} }, 
                remediation.steps.map((step, i) => 
                  e('li', {key: i, style: {marginBottom: '4px'}}, maskPII(step))
                )
              )
            ])
          );
        }
        
        return e('div', null, elements);
      };
      
      function Issue({item, bucket}) {
        const [open, setOpen] = React.useState(false);
        const patch = item.remediation?.patch_hint || '';
        const itemContainsPII = React.useMemo(() => hasPII(item.why) || hasPII(item.remediation?.snippet) || hasPII(item.remediation?.patch_hint), [item]);

        function downloadPatch(){ 
          if(!patch) return; 
          const blob=new Blob([patch],{type:'text/plain'}); 
          const a=document.createElement('a'); 
          a.href=URL.createObjectURL(blob); 
          a.download=(item.id || 'issue')+'.patch'; 
          a.click(); 
          URL.revokeObjectURL(a.href); 
        }
        
        function downloadJSON(){ 
          const blob=new Blob([JSON.stringify(item,null,2)],{type:'application/json'}); 
          const a=document.createElement('a'); 
          a.href=URL.createObjectURL(blob); 
          a.download=(item.id || 'issue')+'.json'; 
          a.click(); 
          URL.revokeObjectURL(a.href); 
        }
        
        const DetailsView = item.remediation?.patch_hint ? CodeHunkIssue : item.remediation?.snippet ? ConfigChangeIssue : () => e('div', {className: 'muted'}, 'No detailed changes available.');
        const riskVar = bucket === 'high' ? 'vz-red' : (bucket === 'medium' ? 'med' : 'low');

        return e('div', {className: 'card issue-card'}, [
            e('div', { className: 'issue-header', onClick: () => setOpen(!open) }, [
                e('div', { className: 'issue-summary' }, [
                    e('p', {className: 'title'}, maskPII(item.why || item.headline)),
                    e('div', {className: 'issue-meta'}, [
                        e('span', {className:'chip', style:{backgroundColor: `var(--${riskVar})`, color: 'white'}}, String(bucket).toUpperCase()),
                        e('span', {className: 'chip'}, getChangeType(item)),
                        e(Churn, {loc: item.locator}),
                        itemContainsPII && e(PIINotice),
                        e('span', {className: 'mono muted'}, item.file)
                    ]),
                ]),
                e('button', {className: `toggle-btn ${open ? 'open': ''}`}, '+')
            ]),
            open && e('div', { className: 'issue-details' }, [
                generateInsight(item),
                e(DetailsView, {item}),
                e('div', {className: 'details-actions'}, [
                    e('button', {className: 'btn', onClick: downloadJSON}, 'Download JSON'),
                    e('button', {className: 'btn primary', onClick: downloadPatch, disabled: !patch}, 'Download Patch')
                ])
            ])
        ]);
      }
      
      const AllowedVarianceIssue = ({item}) => e('div', {className:'card', style:{padding:'16px'}}, [
        e('div', {style:{display: 'flex', alignItems: 'center', gap:'12px', marginBottom: '8px'}}, [
            e('div', {className:'chip', style:{background:'#F3F4F6', color:'#6B7280', border:'1px solid #D1D5DB'}}, 'ALLOWED'),
            e('p', {className: 'title', style:{margin:0, flex: 1}}, item.rationale || item.why)
        ]),
        e('div', {className: 'issue-meta', style:{borderTop: '1px solid var(--line)', paddingTop: '8px'}}, [
            e(LocatorPill, {loc: item.locator}),
            e('span', {className: 'mono muted'}, item.file)
        ])
      ]);

      function groupDriftsByFile(drifts) {
        const grouped = {};
        drifts.forEach(drift => {
          const file = drift.file;
          if (!grouped[file]) {
            grouped[file] = [];
          }
          grouped[file].push(drift);
        });
        return grouped;
      }

      function sortFilesByRisk(fileGroups) {
        const riskPriority = { high: 4, medium: 3, low: 2, allowed: 1 };
        
        return Object.keys(fileGroups).sort((fileNameA, fileNameB) => {
          const driftsA = fileGroups[fileNameA];
          const driftsB = fileGroups[fileNameB];
          const maxRiskA = Math.max(...driftsA.map(d => riskPriority[d._riskLevel] || 0));
          const maxRiskB = Math.max(...driftsB.map(d => riskPriority[d._riskLevel] || 0));
          
          if (maxRiskA !== maxRiskB) {
            return maxRiskB - maxRiskA;
          }
          return fileNameA.localeCompare(fileNameB);
        });
      }

      function FileGroupAll({fileName, drifts}) {
        const [isExpanded, setIsExpanded] = React.useState(false);
        
        const riskCounts = {
          high: drifts.filter(d => d._riskLevel === 'high').length,
          medium: drifts.filter(d => d._riskLevel === 'medium').length,
          low: drifts.filter(d => d._riskLevel === 'low').length,
          allowed: drifts.filter(d => d._riskLevel === 'allowed').length
        };
        
        let fileRiskColor, fileRiskIcon, fileRiskLabel;
        if (riskCounts.high > 0) {
          fileRiskColor = 'var(--vz-red)';
          fileRiskIcon = 'üî¥';
          fileRiskLabel = 'High Risk';
        } else if (riskCounts.medium > 0) {
          fileRiskColor = 'var(--med)';
          fileRiskIcon = 'üü†';
          fileRiskLabel = 'Medium Risk';
        } else if (riskCounts.low > 0) {
          fileRiskColor = 'var(--low)';
          fileRiskIcon = 'üü¢';
          fileRiskLabel = 'Low Risk';
        } else {
          fileRiskColor = 'var(--allowed)';
          fileRiskIcon = '‚úÖ';
          fileRiskLabel = 'Allowed Variance';
        }
        
        const totalDrifts = drifts.length;
        const riskSummary = [
          riskCounts.high > 0 && `${riskCounts.high} high`,
          riskCounts.medium > 0 && `${riskCounts.medium} medium`,
          riskCounts.low > 0 && `${riskCounts.low} low`,
          riskCounts.allowed > 0 && `${riskCounts.allowed} allowed`
        ].filter(Boolean).join(', ');
        
        return e('div', {className: 'file-group-card', style:{
          border: `2px solid ${fileRiskColor}`,
          borderRadius: '12px',
          marginBottom: '20px',
          overflow: 'hidden'
        }}, [
          e('div', {
            className: 'file-header',
            style: {
              backgroundColor: fileRiskColor + '15',
              padding: '16px 20px',
              cursor: 'pointer',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              borderBottom: isExpanded ? `1px solid ${fileRiskColor}40` : 'none'
            },
            onClick: () => setIsExpanded(!isExpanded)
          }, [
            e('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}}, [
              e('span', {style: {fontSize: '20px'}}, fileRiskIcon),
              e('div', null, [
                e('div', {style: {fontWeight: '600', fontSize: '16px', color: fileRiskColor}}, fileName),
                e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 
                  `${totalDrifts} drift${totalDrifts !== 1 ? 's' : ''} ‚Ä¢ ${riskSummary}`)
              ])
            ]),
            e('div', {style: {fontSize: '24px', color: fileRiskColor}}, isExpanded ? '‚àí' : '+')
          ]),
          
          isExpanded && e('div', {style: {padding: '0'}}, [
            riskCounts.high > 0 && e('div', {style: {marginBottom: '16px'}}, [
              e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--vz-red)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, 'üî¥ High Risk'),
              e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'high').map((drift, i) => 
                e(Issue, {key: i, item: drift, bucket: 'high'})
              ))
            ]),
            riskCounts.medium > 0 && e('div', {style: {marginBottom: '16px'}}, [
              e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--med)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, 'üü† Medium Risk'),
              e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'medium').map((drift, i) => 
                e(Issue, {key: i, item: drift, bucket: 'medium'})
              ))
            ]),
            riskCounts.low > 0 && e('div', {style: {marginBottom: '16px'}}, [
              e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--low)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, 'üü¢ Low Risk'),
              e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'low').map((drift, i) => 
                e(Issue, {key: i, item: drift, bucket: 'low'})
              ))
            ]),
            riskCounts.allowed > 0 && e('div', {style: {marginBottom: '16px'}}, [
              e('h3', {style: {fontSize: '14px', fontWeight: '600', color: 'var(--allowed)', margin: '16px 16px 8px', textTransform: 'uppercase'}}, '‚úÖ Allowed Variance'),
              e('div', {className: 'grid-issues'}, drifts.filter(d => d._riskLevel === 'allowed').map((drift, i) => 
                e(AllowedVarianceIssue, {key: i, item: drift, bucket: 'allowed'})
              ))
            ])
          ])
        ]);
      }

      function AllDriftsByFile({data}) {
        if (!data) return null;
        const allDrifts = [
          ...(data.high || []).map(d => ({...d, _riskLevel: 'high'})),
          ...(data.medium || []).map(d => ({...d, _riskLevel: 'medium'})),
          ...(data.low || []).map(d => ({...d, _riskLevel: 'low'})),
          ...(data.allowed_variance || []).map(d => ({...d, _riskLevel: 'allowed'}))
        ];
        const fileGroups = groupDriftsByFile(allDrifts);
        const fileNames = sortFilesByRisk(fileGroups);
        
        return e('div', null, [
          e('h2', {className: 'section-title', style:{color: '#333', borderBottom: '2px solid #333'}}, 
            'üìÅ All Drifts by File'),
          e('div', {style: {marginTop: '16px'}}, fileNames.map(fileName => 
            e(FileGroupAll, {key: fileName, fileName, drifts: fileGroups[fileName]})
          ))
        ]);
      }

      function Bucket({title, items, kind, riskColor, Component}){ 
        if (!items || items.length === 0) return null;
        const itemsWithRisk = items.map(item => ({...item, _riskLevel: kind}));
        const fileGroups = groupDriftsByFile(itemsWithRisk);
        const fileNames = sortFilesByRisk(fileGroups);
        
        return e('div',null, [
          e('h2', {className: 'section-title', style:{color: riskColor, borderBottom: `2px solid ${riskColor}`}}, title),
          e('div', {style: {marginTop: '16px'}}, fileNames.map(fileName => {
            const fileDrifts = fileGroups[fileName];
            const [isExpanded, setIsExpanded] = React.useState(false);
            
            return e('div', {key: fileName, className: 'file-group-card', style:{
              border: `2px solid ${riskColor}`,
              borderRadius: '12px',
              marginBottom: '20px',
              overflow: 'hidden'
            }}, [
              e('div', {
                style: {
                  backgroundColor: riskColor + '15',
                  padding: '16px 20px',
                  cursor: 'pointer',
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  borderBottom: isExpanded ? `1px solid ${riskColor}40` : 'none'
                },
                onClick: () => setIsExpanded(!isExpanded)
              }, [
                e('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}}, [
                  e('span', {style: {fontSize: '20px'}}, 
                    kind === 'high' ? 'üî¥' : kind === 'medium' ? 'üü†' : kind === 'low' ? 'üü¢' : '‚úÖ'),
                  e('div', null, [
                    e('div', {style: {fontWeight: '600', fontSize: '16px', color: riskColor}}, fileName),
                    e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 
                      `${fileDrifts.length} drift${fileDrifts.length !== 1 ? 's' : ''}`)
                  ])
                ]),
                e('div', {style: {fontSize: '24px', color: riskColor}}, isExpanded ? '‚àí' : '+')
              ]),
              
              isExpanded && e('div', {style: {padding: '0'}}, [
                e('div', {className: 'grid-issues'}, fileDrifts.map((drift, i) => 
                  e(Component, {key: i, item: drift, bucket: kind})
                ))
              ])
            ]);
          }))
        ]); 
      }
      
      // ============================================================================
      // END OF HELPER COMPONENTS
      // ============================================================================
      
      function DeploymentTab({serviceId, currentEnvironment}) {
        const [driftData, setDriftData] = React.useState(null);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [activeFilter, setActiveFilter] = React.useState('all');
        
        // Load drift analysis data
        React.useEffect(() => {
          const loadDriftData = async () => {
            if (!serviceId) return;
            
            try {
              setLoading(true);
              const response = await fetch(`/api/services/${serviceId}/llm-output`);
              if (!response.ok) {
                throw new Error('No analysis results available. Run an analysis first.');
              }
              const data = await response.json();
              setDriftData(data.data || {});
              setError(null);
            } catch (err) {
              console.error('Error loading drift data:', err);
              setError(err.message);
              setDriftData(null);
            } finally {
              setLoading(false);
            }
          };
          
          loadDriftData();
        }, [serviceId]);
        
        // Filter functions
        function handleFilterClick(filter) {
          setActiveFilter(activeFilter === filter ? 'all' : filter);
        }

        function getFilteredData() {
          if (!driftData || activeFilter === 'all') return driftData;
          
          const filtered = {
            summary: driftData.summary,
            high: activeFilter === 'high' ? driftData.high : [],
            medium: activeFilter === 'medium' ? driftData.medium : [],
            low: activeFilter === 'low' ? driftData.low : [],
            allowed_variance: activeFilter === 'allowed' ? driftData.allowed_variance : []
          };
          
          return filtered;
        }
        
        if (loading) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, '‚è≥'),
            e('div', {style: {fontSize: '18px'}}, 'Loading drift analysis...'),
            e('div', {className: 'spinner', style: {margin: '20px auto'}})
          ]);
        }
        
        if (error) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, 'üì≠'),
            e('div', {style: {fontSize: '18px', marginBottom: '8px'}}, 'No Analysis Results'),
            e('div', {style: {color: 'var(--muted)', marginBottom: '16px'}}, error),
            e('div', {style: {marginTop: '24px'}}, [
              e('p', {style: {marginBottom: '12px'}}, 'Run an analysis to see drift detection results here')
            ])
          ]);
        }
        
        if (!driftData) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, 'No data available');
        }
        
        // Use filtered data for display
        const displayData = getFilteredData();
        
        // Extract statistics from LLM output summary
        const summary = displayData?.summary || {};
        const totalConfigFiles = summary.total_config_files || 0;
        const filesWithDrift = summary.files_with_drift || 0;
        const totalDrifts = summary.total_drifts || 0;
        
        // Risk counts from LLM output summary
        const counts = { 
          high: summary.high_risk || 0, 
          medium: summary.medium_risk || 0, 
          low: summary.low_risk || 0, 
          allowed: summary.allowed_variance || 0 
        };
        
        return e('div', null, [
          // 7 Stat Boxes (matching index.html exactly)
          e('div', {className:'stats', style:{margin:'0 0 24px 0'}}, [
            // Summary Statistics (Top Row) - Display only (not clickable)
            e('div', {className:'card stat', style:{
              backgroundColor: 'white', 
              border: '1px solid #e0e0e0',
              boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
            }}, [
              e('div',{className:'lbl'}, 'Total Config Files'), 
              e('div',{className:'val', style:{color:'#1a1a1a'}}, totalConfigFiles)
            ]),
            e('div', {className:'card stat', style:{
              backgroundColor: 'white', 
              border: '1px solid #e0e0e0',
              boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
            }}, [
              e('div',{className:'lbl'}, 'Files with Drift'), 
              e('div',{className:'val', style:{color:'#1a1a1a'}}, filesWithDrift)
            ]),
            e('div', {className:'card stat', style:{
              backgroundColor: 'white', 
              border: '1px solid #e0e0e0',
              boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
            }}, [
              e('div',{className:'lbl'}, 'Total Drifts'), 
              e('div',{className:'val', style:{color:'#1a1a1a'}}, totalDrifts)
            ]),
            // Risk Categories (Bottom Row) - Clickable filters
            e('div', {className:'card stat clickable', style:{
              backgroundColor: activeFilter === 'high' ? '#ffebee' : 'white', 
              border: activeFilter === 'high' ? '3px solid var(--vz-red)' : '1px solid var(--line)',
              cursor: 'pointer'
            }, onClick: () => handleFilterClick('high')}, [
              e('div',{className:'lbl'}, 'High Risk'), 
              e('div',{className:'val', style:{color:'var(--vz-red)'}}, counts.high)
            ]),
            e('div', {className:'card stat clickable', style:{
              backgroundColor: activeFilter === 'medium' ? '#fff3e0' : 'white', 
              border: activeFilter === 'medium' ? '3px solid var(--med)' : '1px solid var(--line)',
              cursor: 'pointer'
            }, onClick: () => handleFilterClick('medium')}, [
              e('div',{className:'lbl'}, 'Medium Risk'), 
              e('div',{className:'val', style:{color:'var(--med)'}}, counts.medium)
            ]),
            e('div', {className:'card stat clickable', style:{
              backgroundColor: activeFilter === 'low' ? '#f3e5f5' : 'white', 
              border: activeFilter === 'low' ? '3px solid var(--low)' : '1px solid var(--line)',
              cursor: 'pointer'
            }, onClick: () => handleFilterClick('low')}, [
              e('div',{className:'lbl'}, 'Low Risk'), 
              e('div',{className:'val', style:{color:'var(--low)'}}, counts.low)
            ]),
            e('div', {className:'card stat clickable', style:{
              backgroundColor: activeFilter === 'allowed' ? '#e8f5e8' : 'white', 
              border: activeFilter === 'allowed' ? '3px solid var(--allowed)' : '1px solid var(--line)',
              cursor: 'pointer'
            }, onClick: () => handleFilterClick('allowed')}, [
              e('div',{className:'lbl'}, 'Allowed Variance'), 
              e('div',{className:'val', style:{color:'var(--allowed)'}}, counts.allowed)
            ])
          ]),
          
          // Drift Display Area
          e('div', {className: 'grid-issues', style:{gap: '32px'}}, [
            counts.high + counts.medium + counts.low + counts.allowed === 0 ? 
              e('div',{className:'success-banner'}, [
                e('p',{style:{fontSize:'18px',fontWeight:'bold',marginBottom:'4px'}}, 
                  activeFilter === 'all' ? '‚úÖ No Drift Detected' : `‚úÖ No ${activeFilter} risk items found`),
                e('p',{style:{margin:0}}, 
                  activeFilter === 'all' ? 'All configurations match the golden state. No action required.' : 
                  `Try clicking "Total Drifts" to see all items.`)
              ]) : null,
            
            // Show file-grouped view when "all" is selected, otherwise show risk-grouped view
            activeFilter === 'all' ? 
              e(AllDriftsByFile, {data: displayData}) : [
                e(Bucket,{title:'üî¥ High Risk Changes', items: displayData.high, kind:'high', riskColor: 'var(--vz-red)', Component: Issue}),
                e(Bucket,{title:'üü† Medium Risk Changes', items: displayData.medium, kind:'medium', riskColor: 'var(--med)', Component: Issue}),
                e(Bucket,{title:'üü¢ Low Risk Changes', items: displayData.low, kind:'low', riskColor: 'var(--low)', Component: Issue}),
                e(Bucket,{title:'‚úÖ Allowed Variance', items: displayData.allowed_variance, kind:'allowed', riskColor: 'var(--allowed)', Component: AllowedVarianceIssue})
              ]
          ])
        ]);
      }
      
      function CertificationsTab({issueData, onStagingClick, serviceConfig, serviceId, onCertificationUpdate}) {
        const [certifications, setCertifications] = React.useState({});
        const [loading, setLoading] = React.useState({});
        const [error, setError] = React.useState(null);
        
        // Load certification status for all environments
        React.useEffect(() => {
          const loadCertifications = async () => {
            if (!serviceConfig) return;
            
            // Get environments from service configuration (no hardcoded values)
            const environments = serviceConfig?.environments || ['prod', 'dev', 'qa', 'staging'];
            
            const certData = {};
            for (const env of environments) {
              try {
                const response = await fetch(`/api/services/${serviceId}/validate-golden/${env}`);
                const data = await response.json();
                certData[env] = data;
              } catch (err) {
                certData[env] = { golden_exists: false, error: err.message };
              }
            }
            setCertifications(certData);
          };
          loadCertifications();
        }, [serviceConfig, serviceId]);
        
        const handleCertify = async (environment) => {
          setLoading(prev => ({ ...prev, [environment]: true }));
          setError(null);
          
          try {
            const response = await fetch(`/api/services/${serviceId}/set-golden/${environment}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to certify ${environment}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Update certifications state
            setCertifications(prev => ({
              ...prev,
              [environment]: {
                golden_exists: true,
                active_golden_branch: result.branch_name,
                service_id: serviceId,
                environment: environment
              }
            }));
            
            // Trigger overview tab update
            if (onCertificationUpdate) {
              onCertificationUpdate();
            }
            
          } catch (err) {
            setError(`Failed to certify ${environment}: ${err.message}`);
          } finally {
            setLoading(prev => ({ ...prev, [environment]: false }));
          }
        };
        
        const handleRevoke = async (environment) => {
          setLoading(prev => ({ ...prev, [environment]: true }));
          setError(null);
          
          try {
            const response = await fetch(`/api/services/${serviceId}/revoke-golden/${environment}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
              throw new Error(`Failed to revoke ${environment}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            // Update certifications state
            setCertifications(prev => ({
              ...prev,
              [environment]: {
                golden_exists: false,
                active_golden_branch: null,
                service_id: serviceId,
                environment: environment
              }
            }));
            
            // Trigger overview tab update
            if (onCertificationUpdate) {
              onCertificationUpdate();
            }
            
          } catch (err) {
            setError(`Failed to revoke ${environment}: ${err.message}`);
          } finally {
            setLoading(prev => ({ ...prev, [environment]: false }));
          }
        };
        
        const getEnvironmentDisplayName = (env) => {
          const names = {
            'prod': 'Production',
            'dev': 'Development', 
            'qa': 'QA',
            'staging': 'Staging'
          };
          return names[env] || env;
        };
        
        const getEnvironmentColor = (env) => {
          const colors = {
            'prod': 'var(--ink)',
            'dev': 'var(--ink)',
            'qa': 'var(--ink)', 
            'staging': 'var(--ink)'
          };
          return colors[env] || 'var(--muted)';
        };
        
        return e('div', {className: 'card'}, [
          e('h3', {style: {margin: '0 0 20px 0'}}, 'Environment Certification & Golden Branches'),
          e('p', {style: {color: 'var(--muted)', margin: '0 0 24px 0'}}, 
            'Certify environments to create golden branches for drift analysis baseline'),
          
          // Error message
          error && e('div', {style: {background: 'var(--red-bg)', border: '1px solid var(--red)', borderRadius: '8px', padding: '12px', marginBottom: '16px', color: 'var(--red)'}}, 
            `‚ùå ${error}`
          ),
          
          // Environment certifications
          ...(() => {
            // Get environments from service config (dynamic, no hardcoded values)
            const environments = serviceConfig?.environments || [];
            return environments.map(env => {
            const cert = certifications[env] || {};
            const isCertified = cert.golden_exists;
            const isLoading = loading[env];
            
            return e('div', {key: env, className: 'env-cert'}, [
              // Top row: Environment name + Certified tag on left, buttons on far right
              e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px'}}, [
                e('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}}, [
                  e('div', {className: 'env-name', style: {color: getEnvironmentColor(env)}}, 
                    getEnvironmentDisplayName(env)
                  ),
                  isCertified && e('span', {className: 'badge success'}, [
                    e('span', null, '‚úì'),
                'Certified'
            ])
          ]),
                e('div', {style: {display: 'flex', gap: '8px'}}, [
                  isCertified ? [
                    e('button', {
                      className: 'btn',
                      disabled: isLoading,
                      onClick: () => handleRevoke(env),
                      style: {backgroundColor: '#F3F4F6', color: '#111827', border: '1px solid #D1D5DB'}
                    }, [
                      e('span', {style: {marginRight: '6px'}}, '√ó'),
                      isLoading ? 'Revoking...' : 'Revoke'
                    ]),
                    e('button', {
                      className: 'btn',
                      disabled: isLoading,
                      onClick: () => handleCertify(env),
                      style: {backgroundColor: '#F3F4F6', color: '#111827', border: '1px solid #D1D5DB'}
                    }, [
                      e('span', {style: {marginRight: '6px'}}, '‚Üª'),
                      isLoading ? 'Re-certifying...' : 'Re-certify'
                    ])
                  ] : [
                    e('button', {
                      className: 'btn',
                      disabled: isLoading,
                      onClick: () => handleCertify(env),
                      style: {backgroundColor: '#F3F4F6', color: '#111827', border: '1px solid #D1D5DB'}
                    }, isLoading ? 'Certifying...' : 'Certify')
                  ]
                ])
              ]),
              // Details below the environment name (not on the right)
              e('div', {style: {marginLeft: '0'}}, [
                isCertified ? [
                  e('div', {className: 'env-details'}, 
                    `Golden Branch: ${cert.active_golden_branch || 'Unknown'}`
                  ),
                  e('div', {className: 'env-details'}, 
                    `Certified and ready for drift analysis`
                  )
                ] : [
                  e('div', {className: 'env-details'}, 
                    'No golden branch found - certification required'
                  ),
                  e('div', {className: 'env-details'}, 
                    'Click "Certify" to create golden baseline'
                  )
                ]
              ])
            ]);
          });
          })()
        ]);
      }
      
      function HistoryTab({serviceId, currentEnvironment}) {
        const [runHistory, setRunHistory] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState(null);
        const [selectedEnv, setSelectedEnv] = React.useState(currentEnvironment || 'prod');
        
        // Load run history from API
        React.useEffect(() => {
          const loadRunHistory = async () => {
            if (!serviceId || !selectedEnv) return;
            
            try {
              setLoading(true);
              const response = await fetch(`/api/services/${serviceId}/run-history/${selectedEnv}`);
              if (!response.ok) throw new Error('Failed to load run history');
              const data = await response.json();
              setRunHistory(data.runs || []);
              setError(null);
            } catch (err) {
              console.error('Error loading run history:', err);
              setError(err.message);
              setRunHistory([]);
            } finally {
              setLoading(false);
            }
          };
          
          loadRunHistory();
        }, [serviceId, selectedEnv]);
        
        // Format timestamp
        const formatTimestamp = (isoString) => {
          try {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          } catch {
            return isoString;
          }
        };
        
        // Get verdict badge configuration
        const getVerdictBadge = (verdict) => {
          const configs = {
            'PASS': { className: 'badge success', text: '‚úÖ PASS' },
            'WARN': { className: 'badge warning', text: '‚ö†Ô∏è WARN' },
            'REVIEW_REQUIRED': { className: 'badge warning', text: 'üîç REVIEW' },
            'BLOCK': { className: 'badge danger', text: 'üö´ BLOCK' },
            'COMPLETED': { className: 'badge success', text: '‚úÖ COMPLETED' }
          };
          return configs[verdict] || { className: 'badge', text: verdict };
        };
        
        // Handle click to view run details
        const handleViewRun = (run) => {
          window.location.href = `/service/${serviceId}?run_id=${run.run_id}&env=${selectedEnv}`;
        };
        
        if (loading) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '24px', marginBottom: '16px'}}, '‚è≥'),
            e('div', null, 'Loading analysis history...')
          ]);
        }
        
        if (error) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '24px', marginBottom: '16px', color: 'var(--red)'}}, '‚ùå'),
            e('div', null, `Error: ${error}`),
            e('button', {
              className: 'btn',
              style: {marginTop: '16px'},
              onClick: () => window.location.reload()
            }, 'Retry')
          ]);
        }
        
        if (runHistory.length === 0) {
          return e('div', {className: 'card', style: {textAlign: 'center', padding: '40px'}}, [
            e('div', {style: {fontSize: '48px', marginBottom: '16px'}}, 'üì≠'),
            e('div', {style: {fontSize: '18px', marginBottom: '8px'}}, 'No analysis runs yet'),
            e('div', {style: {color: 'var(--muted)', marginTop: '8px'}}, 
              `Run an analysis for ${selectedEnv} environment to see results here`)
          ]);
        }
        
        return e('div', {className: 'card'}, [
          e('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}, [
            e('h3', {style: {margin: '0'}}, `Analysis History (${runHistory.length} runs)`),
            e('div', {style: {fontSize: '14px', color: 'var(--muted)'}}, 
              `Environment: ${selectedEnv.toUpperCase()}`)
          ]),
          
          // Run list
          runHistory.map((run, index) => {
            const badge = getVerdictBadge(run.verdict);
            const metrics = run.metrics || {};
            const branches = run.branches || {};
            
            return e('div', {
              key: run.run_id || index,
              className: 'commit-item',
              style: {
                cursor: 'pointer',
                transition: 'all 0.2s ease',
                borderLeft: `4px solid ${
                  run.verdict === 'PASS' ? 'var(--green)' :
                  run.verdict === 'WARN' ? 'var(--yellow)' :
                  run.verdict === 'BLOCK' ? 'var(--red)' :
                  'var(--blue)'
                }`
              },
              onClick: () => handleViewRun(run),
              onMouseEnter: (e) => {
                e.currentTarget.style.background = '#f8f9fa';
                e.currentTarget.style.transform = 'translateX(4px)';
              },
              onMouseLeave: (e) => {
                e.currentTarget.style.background = 'transparent';
                e.currentTarget.style.transform = 'translateX(0)';
              }
            }, [
              // Header row - Run number and verdict
              e('div', {style: {display: 'flex', justifyContent: 'space-between', marginBottom: '8px', alignItems: 'center'}}, [
                e('div', null, [
                  e('strong', {style: {fontSize: '16px'}}, `Run #${runHistory.length - index}`),
                  e('span', {style: {color: 'var(--muted)', marginLeft: '12px', fontSize: '14px'}}, 
                    formatTimestamp(run.timestamp))
                ]),
                e('span', {className: badge.className}, badge.text)
              ]),
              
              // Metrics row
              e('div', {className: 'commit-meta', style: {marginBottom: '8px'}}, [
                `${metrics.files_with_drift || 0} files drifted ‚Ä¢ `,
                `${metrics.total_deltas || 0} changes ‚Ä¢ `,
                `${metrics.policy_violations || 0} violations ‚Ä¢ `,
                `Risk: ${metrics.overall_risk_level || 'unknown'}`
              ]),
              
              // Branches info
              e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginBottom: '4px'}}, [
                `Golden: ${branches.golden_branch || 'N/A'}`
              ]),
              e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginBottom: '8px'}}, [
                `Drift: ${branches.drift_branch || 'N/A'}`
              ]),
              
              // Execution time
              e('div', {style: {fontSize: '12px', color: 'var(--muted)', marginBottom: '8px'}}, [
                `‚è±Ô∏è Execution time: ${run.execution_time_seconds ? run.execution_time_seconds.toFixed(1) : 'N/A'}s`
              ]),
              
              // View link
              e('div', {
                style: {
                  marginTop: '8px',
                  color: 'var(--primary)',
                  fontSize: '14px',
                  fontWeight: '500',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '4px'
                }
              }, [
                e('span', null, '‚Üí Click to view detailed analysis'),
                e('span', {style: {fontSize: '12px', color: 'var(--muted)'}}, `(${run.run_id.substring(0, 30)}...)`)
              ])
            ]);
          })
        ]);
      }
      
      function StagingModal({onClose, onPromote, onReview, issueData}) {
        return e('div', {className: 'modal-overlay', onClick: onClose}, [
          e('div', {className: 'modal', onClick: (e) => e.stopPropagation()}, [
            e('h3', null, 'üîÑ Staging Environment Actions'),
            e('p', null, `Manage staging deployment for ${serviceConfig?.name || serviceId}`),
            e('p', {style: {color: 'var(--yellow)'}}, 'Current Status: Pending Certification Review'),
            
            e('div', {style: {background: '#fff8dc', padding: '12px', borderRadius: '8px', margin: '16px 0'}}, [
              e('strong', null, 'Available Actions:'),
              e('ul', {style: {margin: '8px 0 0 0'}}, [
                e('li', null, 'Promote changes to staging for testing'),
                e('li', null, 'Request security team review'),
                e('li', null, 'Schedule certification review meeting')
              ])
            ]),
            
            e('div', {className: 'modal-actions'}, [
              e('button', {className: 'btn', onClick: onClose}, 'Cancel'),
              e('button', {className: 'btn warning', onClick: onReview}, 'Request Review'),
              e('button', {className: 'btn success', onClick: onPromote}, 'Promote to Staging')
            ])
          ])
        ]);
      }
      
      ReactDOM.createRoot(document.getElementById('root')).render(e(BranchEnvironmentPage));
    })();
  </script>
</body>
</html>